<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>From Factoring to Period Finding — Shor's Algorithm</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap');

  :root {
    --bg: #0a0e1a;
    --surface: #111827;
    --surface2: #1a2236;
    --border: #2a3550;
    --text: #e2e8f0;
    --text-dim: #8892a8;
    --accent: #6366f1;
    --accent-glow: rgba(99, 102, 241, 0.3);
    --cyan: #22d3ee;
    --cyan-glow: rgba(34, 211, 238, 0.25);
    --pink: #f472b6;
    --pink-glow: rgba(244, 114, 182, 0.25);
    --green: #34d399;
    --green-glow: rgba(52, 211, 153, 0.25);
    --orange: #fb923c;
    --yellow: #facc15;
    --red: #f87171;

    /* Module-specific variables */
    --accent2: #818cf8;
    --radius: 12px;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }
  html { scroll-behavior: smooth; }

  body {
    font-family: 'Inter', sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.7;
    overflow-x: hidden;
  }

  /* ── Particle Background ─────────────────────── */
  #particleBg {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: -1;
    pointer-events: none;
  }

  /* ── Sticky Nav ───────────────────────────────── */
  #sticky-nav {
    position: fixed;
    top: 0; left: 0; right: 0;
    z-index: 1000;
    background: rgba(10,14,26,0.92);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    transform: translateY(-100%);
    transition: transform 0.3s ease;
  }
  #sticky-nav.visible { transform: translateY(0); }
  #scroll-progress {
    height: 3px;
    background: linear-gradient(90deg, var(--accent), var(--cyan));
    width: 0%;
    transition: width 0.08s linear;
  }
  .nav-inner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 10px 24px;
    max-width: 960px;
    margin: 0 auto;
  }
  .nav-title {
    font-weight: 700;
    font-size: 0.88rem;
    color: var(--text);
    white-space: nowrap;
  }
  .nav-links { display: flex; gap: 4px; }
  .nav-link {
    color: var(--text-dim);
    text-decoration: none;
    font-size: 0.78rem;
    font-weight: 500;
    padding: 4px 9px;
    border-radius: 6px;
    transition: color 0.2s, background 0.2s;
    white-space: nowrap;
  }
  .nav-link:hover { color: var(--text); background: var(--surface2); }
  .nav-link.active { color: var(--accent); background: rgba(99,102,241,0.1); }

  .nav-hamburger {
    display: none;
    flex-direction: column;
    gap: 4px;
    padding: 6px;
    background: transparent;
    border: 1px solid var(--border);
    border-radius: 6px;
    cursor: pointer;
  }
  .hamburger-line {
    display: block;
    width: 18px;
    height: 2px;
    background: var(--text);
    border-radius: 1px;
    transition: transform 0.2s, opacity 0.2s;
  }
  .nav-hamburger[aria-expanded="true"] .hamburger-line:nth-child(1) {
    transform: translateY(6px) rotate(45deg);
  }
  .nav-hamburger[aria-expanded="true"] .hamburger-line:nth-child(2) {
    opacity: 0;
  }
  .nav-hamburger[aria-expanded="true"] .hamburger-line:nth-child(3) {
    transform: translateY(-6px) rotate(-45deg);
  }

  /* ── Skip Link ─────────────────────────────── */
  .skip-link {
    position: absolute;
    top: -100%;
    left: 16px;
    background: var(--accent);
    color: #fff;
    padding: 8px 16px;
    border-radius: 0 0 8px 8px;
    z-index: 1001;
    font-size: 0.9rem;
    font-weight: 600;
    text-decoration: none;
    transition: top 0.2s;
  }
  .skip-link:focus { top: 0; }

  /* ── Hero ─────────────────────────────────────── */
  .hero {
    text-align: center;
    padding: 80px 24px 60px;
    background: linear-gradient(180deg, #111827 0%, var(--bg) 100%);
    border-bottom: 1px solid var(--border);
    position: relative;
  }
  .hero::after {
    content: '';
    display: block;
    width: 120px;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), var(--cyan), transparent);
    margin: 1.5rem auto 0;
  }
  .hero h1 {
    font-size: clamp(2rem, 5vw, 3.2rem);
    font-weight: 700;
    letter-spacing: -0.02em;
    background: linear-gradient(135deg, var(--accent), var(--cyan), var(--pink));
    -webkit-background-clip: text;
    background-clip: text;
    -webkit-text-fill-color: transparent;
    margin-bottom: 16px;
  }
  .hero p {
    font-size: 1.05rem;
    color: var(--text-dim);
    font-weight: 300;
    max-width: 680px;
    margin: 0 auto;
  }

  /* ── Layout ───────────────────────────────────── */
  .container {
    max-width: 960px;
    margin: 0 auto;
    padding: 0 24px;
  }

  section {
    padding: 56px 0;
    border-bottom: 1px solid var(--border);
  }
  section:last-of-type { border-bottom: none; }
  section[id] { scroll-margin-top: 64px; }

  /* Scroll-triggered fade-in */
  section .container {
    opacity: 0;
    transform: translateY(28px);
    transition: opacity 0.55s ease, transform 0.55s ease;
  }
  section .container.in-view {
    opacity: 1;
    transform: translateY(0);
  }

  h2 {
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 8px;
    color: var(--text);
  }
  h2 .step-num {
    display: inline-block;
    background: var(--accent);
    color: #fff;
    width: 36px; height: 36px;
    border-radius: 50%;
    text-align: center;
    line-height: 36px;
    font-size: 0.95rem;
    margin-right: 10px;
    vertical-align: middle;
  }
  h3 {
    font-size: 1.15rem;
    font-weight: 600;
    margin: 24px 0 8px;
    color: var(--pink);
  }

  p, li { color: var(--text-dim); font-size: 1rem; }
  p { margin-bottom: 14px; }
  ul, ol { padding-left: 24px; margin-bottom: 14px; }
  li { margin-bottom: 6px; }

  .math {
    font-family: 'Cambria Math', 'Latin Modern Math', 'STIX Two Math', Georgia, serif;
    font-style: italic;
    color: var(--cyan);
  }
  .math-block {
    display: block;
    text-align: center;
    font-family: 'Cambria Math', 'Latin Modern Math', 'STIX Two Math', Georgia, serif;
    font-size: 1.2rem;
    color: var(--cyan);
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 18px 24px;
    margin: 18px 0;
    overflow-x: auto;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px;
    margin: 20px 0;
    position: relative;
    overflow: hidden;
    transition: border-color 0.3s;
  }
  .card:hover { border-color: rgba(99,102,241,0.4); }
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 1px;
    background: linear-gradient(90deg, transparent, var(--accent), transparent);
    opacity: 0.5;
  }
  .card-accent { border-left: 4px solid var(--accent); }
  .card-warn  { border-left: 4px solid var(--orange); }

  .tag {
    display: inline-block;
    font-size: 0.78rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    padding: 3px 10px;
    border-radius: 6px;
    margin-bottom: 10px;
  }
  .tag-info  { background: rgba(99,102,241,0.15); color: var(--accent); }
  .tag-warn  { background: rgba(251,146,60,0.15); color: var(--orange); }
  .tag-ok    { background: rgba(52,211,153,0.15); color: var(--green); }

  /* ── Glossary Tooltips ─────────────────────── */
  .glossary {
    position: relative;
    border-bottom: 1px dashed var(--accent);
    cursor: help;
    color: var(--text);
  }
  .glossary .glossary-tip {
    visibility: hidden;
    opacity: 0;
    position: absolute;
    bottom: calc(100% + 8px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 10px 14px;
    font-size: 0.82rem;
    color: var(--text-dim);
    line-height: 1.5;
    width: max-content;
    max-width: min(280px, 90vw);
    z-index: 100;
    pointer-events: none;
    transition: opacity 0.2s, visibility 0.2s;
    font-style: normal;
    font-weight: 400;
    text-align: left;
    white-space: normal;
    overflow-wrap: break-word;
  }
  .glossary:hover .glossary-tip,
  .glossary:focus .glossary-tip {
    visibility: visible;
    opacity: 1;
  }

  /* ── Algorithm Pipeline ──────────────────────── */
  .pipeline {
    display: flex;
    align-items: center;
    gap: 0;
    margin: 20px 0;
    padding: 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow-x: auto;
  }
  .pipe-step {
    flex-shrink: 0;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 12px 14px;
    text-align: center;
    min-width: 100px;
  }
  .pipe-step-start { border-left: 3px solid var(--accent); }
  .pipe-step-end { border-left: 3px solid var(--green); }
  .pipe-label {
    font-weight: 700;
    font-size: 0.82rem;
    color: var(--text);
    margin-bottom: 4px;
  }
  .pipe-detail {
    font-size: 0.75rem;
    color: var(--text-dim);
    font-family: 'Cambria Math', Georgia, serif;
    font-style: italic;
  }
  .pipe-arrow {
    color: var(--text-dim);
    font-size: 1.2rem;
    padding: 0 6px;
    flex-shrink: 0;
  }
  .pipe-branch {
    display: flex;
    flex-direction: column;
    gap: 3px;
    margin-top: 4px;
  }
  .pipe-tag {
    font-size: 0.7rem;
    padding: 2px 6px;
    border-radius: 4px;
    font-weight: 600;
  }
  .pipe-tag-ok { background: rgba(52,211,153,0.12); color: var(--green); }
  .pipe-tag-fail { background: rgba(248,113,113,0.12); color: var(--red); }
  .pipe-tag-lucky { background: rgba(34,211,238,0.12); color: var(--cyan); }

  /* ── Controls ─────────────────────────────────── */
  .controls {
    display: flex;
    flex-wrap: wrap;
    gap: 16px;
    align-items: flex-end;
    margin: 20px 0;
  }
  .control-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  .control-group label {
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--text-dim);
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }
  select, button, input[type="number"] {
    font-family: inherit;
    font-size: 0.95rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--surface2);
    color: var(--text);
    padding: 10px 16px;
    cursor: pointer;
    transition: border-color 0.2s, background 0.2s;
  }
  input[type="number"] { cursor: text; width: 140px; }
  select:hover, button:hover, input[type="number"]:focus {
    border-color: var(--accent);
  }
  select:focus-visible, button:focus-visible, input[type="number"]:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  button:focus:not(:focus-visible), select:focus:not(:focus-visible), input[type="number"]:focus:not(:focus-visible) {
    outline: none;
  }
  button.primary {
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #fff;
    border: none;
    font-weight: 600;
  }
  button.primary:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 20px var(--accent-glow);
  }
  button.primary:active { transform: translateY(0); }
  button.sm {
    font-size: 0.8rem;
    padding: 6px 12px;
  }
  button:disabled {
    opacity: 0.4;
    cursor: not-allowed;
  }

  /* ── Table ────────────────────────────────────── */
  .seq-table-wrap {
    overflow-x: auto;
    margin: 16px 0;
    border-radius: var(--radius);
    border: 1px solid var(--border);
  }
  .seq-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
    min-width: 500px;
  }
  .seq-table th, .seq-table td {
    padding: 10px 14px;
    text-align: center;
    border-bottom: 1px solid var(--border);
  }
  .seq-table th {
    background: var(--surface2);
    color: var(--text-dim);
    font-weight: 600;
    font-size: 0.82rem;
    text-transform: uppercase;
    letter-spacing: 0.04em;
    position: sticky;
    top: 0;
  }
  .seq-table td {
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
  }
  .seq-table tr:last-child td { border-bottom: none; }
  .seq-table .highlight {
    background: rgba(99,102,241,0.12);
    font-weight: 700;
    color: var(--accent);
  }
  .seq-table .period-start {
    border-left: 3px solid var(--accent);
  }

  /* ── Bar chart ────────────────────────────────── */
  .chart-container {
    margin: 20px 0;
    padding: 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
  }
  .chart-label {
    font-size: 0.82rem;
    color: var(--text-dim);
    margin-bottom: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.04em;
  }
  .bar-chart {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 200px;
    padding-bottom: 28px;
    position: relative;
    overflow-x: auto;
  }
  .bar-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex-shrink: 0;
    min-width: 22px;
    position: relative;
    height: 100%;
    justify-content: flex-end;
  }
  .bar {
    width: 18px;
    border-radius: 4px 4px 0 0;
    transition: height 0.5s ease, background 0.3s;
    position: relative;
    cursor: default;
    will-change: height;
  }
  .bar-val {
    position: absolute;
    top: -20px;
    font-size: 0.7rem;
    color: var(--text-dim);
    white-space: nowrap;
    opacity: 0;
    transition: opacity 0.2s;
  }
  .bar-group:hover .bar-val { opacity: 1; }
  .bar:hover {
    filter: brightness(1.3);
    transform: scaleY(1.05);
    transform-origin: bottom;
  }
  .bar-x {
    position: absolute;
    bottom: 0;
    font-size: 0.68rem;
    color: var(--text-dim);
    transform: translateY(100%);
    padding-top: 4px;
  }
  .period-bracket {
    position: absolute;
    bottom: -44px;
    height: 18px;
    border: 2px solid var(--accent);
    border-top: none;
    border-radius: 0 0 6px 6px;
    pointer-events: none;
  }
  .period-bracket-label {
    position: absolute;
    bottom: -64px;
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--accent);
    white-space: nowrap;
  }

  /* ── Circle Viz ───────────────────────────────── */
  #circle-svg {
    display: block;
    margin: 0 auto;
    max-width: 100%;
    height: auto;
  }
  #circle-svg text {
    font-family: 'JetBrains Mono', monospace;
  }
  #circle-svg .node-group {
    opacity: 0;
    transition: opacity 0.4s ease;
    will-change: opacity;
  }
  #circle-svg .node-group.visible { opacity: 1; }
  #circle-svg .arrow-path {
    opacity: 0;
    transition: opacity 0.35s ease;
    will-change: opacity;
  }
  #circle-svg .arrow-path.visible { opacity: 1; }

  /* ── Result box ───────────────────────────────── */
  .result-box {
    padding: 20px 24px;
    border-radius: var(--radius);
    margin: 16px 0;
    font-size: 0.95rem;
    line-height: 1.8;
  }
  .result-box.success {
    background: rgba(52,211,153,0.08);
    border: 1px solid rgba(52,211,153,0.25);
    color: var(--green);
  }
  .result-box.fail {
    background: rgba(248,113,113,0.08);
    border: 1px solid rgba(248,113,113,0.25);
    color: var(--red);
  }
  .result-box.info {
    background: rgba(99,102,241,0.08);
    border: 1px solid rgba(99,102,241,0.25);
    color: var(--accent);
  }
  .result-box .label {
    font-weight: 700;
    margin-right: 6px;
  }

  /* ── Step flow ────────────────────────────────── */
  #walkthrough-steps .wt-step {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 24px;
    margin: 12px 0;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity 0.4s, transform 0.4s, border-color 0.3s;
    will-change: opacity, transform;
  }
  #walkthrough-steps .wt-step.active {
    opacity: 1;
    transform: translateY(0);
    border-color: var(--accent);
  }
  #walkthrough-steps .wt-step.done {
    opacity: 0.65;
    transform: translateY(0);
    border-color: var(--green);
  }
  .wt-step h4 {
    font-size: 1rem;
    font-weight: 700;
    margin-bottom: 6px;
  }
  .wt-step p { margin-bottom: 0; }
  .wt-step .mono {
    font-family: 'JetBrains Mono', monospace;
    color: var(--cyan);
  }

  /* ── Step controls ────────────────────────────── */
  #step-controls {
    display: none;
    margin: 16px 0;
  }
  .step-controls-inner {
    display: flex;
    gap: 12px;
    align-items: center;
    flex-wrap: wrap;
  }
  #step-counter {
    color: var(--text-dim);
    font-size: 0.85rem;
    font-family: 'JetBrains Mono', monospace;
  }
  .progress-dots {
    display: flex;
    gap: 6px;
    align-items: center;
    justify-content: center;
    margin-top: 10px;
  }
  .progress-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--border);
    transition: all 0.3s;
  }
  .progress-dot.active {
    background: var(--accent);
    box-shadow: 0 0 8px var(--accent-glow);
  }
  .progress-dot.done {
    background: var(--green);
  }

  /* ── GCD Animation ────────────────────────────── */
  .gcd-steps {
    margin-top: 10px;
    padding: 12px 16px;
    background: var(--surface2);
    border-radius: 8px;
  }
  .gcd-step-line {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    padding: 3px 0;
    color: var(--text-dim);
    opacity: 0;
    transform: translateX(-8px);
    transition: opacity 0.3s, transform 0.3s;
    will-change: opacity, transform;
  }
  .gcd-step-line.visible {
    opacity: 1;
    transform: translateX(0);
  }
  .gcd-step-line .remainder { color: var(--cyan); font-weight: 700; }
  .gcd-step-line.final {
    margin-top: 6px;
    font-weight: 700;
    color: var(--green);
  }

  /* ── Playground ───────────────────────────────── */
  .playground-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 20px;
  }
  .playground-grid .card { margin: 0; }

  .stat {
    display: flex;
    justify-content: space-between;
    padding: 8px 0;
    border-bottom: 1px solid var(--border);
    font-size: 0.92rem;
  }
  .stat:last-child { border-bottom: none; }
  .stat-label { color: var(--text-dim); }
  .stat-value {
    font-weight: 700;
    font-family: 'JetBrains Mono', monospace;
  }

  /* ── Quiz ─────────────────────────────────────── */
  .quiz-question { margin: 20px 0; }
  .quiz-q-text {
    font-weight: 600;
    color: var(--text);
    margin-bottom: 10px;
    font-size: 1rem;
  }
  .quiz-option {
    display: block;
    width: 100%;
    text-align: left;
    padding: 12px 16px;
    margin: 6px 0;
    background: var(--surface2);
    border: 2px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-size: 0.92rem;
    transition: border-color 0.2s, background 0.2s;
  }
  .quiz-option:hover:not(.answered) {
    border-color: var(--accent);
  }
  .quiz-option.correct {
    border-color: var(--green);
    background: rgba(52,211,153,0.08);
    cursor: default;
  }
  .quiz-option.incorrect {
    border-color: var(--red);
    background: rgba(248,113,113,0.08);
    cursor: default;
  }
  .quiz-option.answered { cursor: default; }
  .quiz-option.dimmed { opacity: 0.45; cursor: default; }
  .quiz-explanation {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease, padding 0.4s ease;
    background: var(--surface);
    border-radius: 0 0 var(--radius) var(--radius);
    border: 1px solid var(--border);
    border-top: none;
    padding: 0 16px;
    color: var(--text-dim);
    font-size: 0.9rem;
    line-height: 1.6;
  }
  .quiz-explanation.open {
    max-height: 200px;
    padding: 14px 16px;
  }
  #quiz-score {
    margin-top: 20px;
    padding: 16px 20px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    font-size: 1rem;
    font-weight: 600;
  }

  /* ── Exercise Links ─────────────────────────── */
  .exercise-link {
    color: var(--accent);
    text-decoration: none;
    border-bottom: 1px dashed var(--accent);
    cursor: pointer;
    font-weight: 600;
    font-size: 0.88rem;
    white-space: nowrap;
  }
  .exercise-link:hover {
    color: #818cf8;
    border-bottom-style: solid;
  }

  /* ── Custom N ─────────────────────────────────── */
  #custom-n-area { display: none; margin-top: 8px; }
  #custom-n-area .custom-n-row {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-wrap: wrap;
  }
  #custom-n-error {
    color: var(--red);
    font-size: 0.82rem;
    margin-top: 4px;
    min-height: 1.2em;
  }
  #custom-n-info {
    color: var(--green);
    font-size: 0.82rem;
    margin-top: 4px;
  }

  /* ── Outcome Bar (Batch) ────────────────────── */
  .outcome-bar {
    display: flex;
    height: 28px;
    border-radius: 6px;
    overflow: hidden;
    margin: 16px 0 8px;
    gap: 2px;
  }
  .outcome-seg {
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.72rem;
    font-weight: 700;
    color: var(--bg);
    transition: width 0.5s ease;
    min-width: 4px;
  }
  .outcome-legend {
    display: flex;
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 4px;
  }
  .outcome-legend-item {
    display: flex;
    align-items: center;
    gap: 5px;
    font-size: 0.78rem;
    color: var(--text-dim);
  }
  .outcome-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }
  .batch-spinner {
    display: inline-block;
    width: 18px;
    height: 18px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    vertical-align: middle;
    margin-right: 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ── Footer ───────────────────────────────────── */
  footer {
    padding: 40px 24px;
    color: var(--text-dim);
    font-size: 0.85rem;
  }
  .footer-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 32px;
    margin-bottom: 24px;
    text-align: left;
  }
  .footer-heading {
    font-weight: 600;
    font-size: 0.82rem;
    text-transform: uppercase;
    letter-spacing: 0.06em;
    color: var(--text);
    margin-bottom: 10px;
  }
  .footer-link {
    display: block;
    color: var(--text-dim);
    text-decoration: none;
    font-size: 0.85rem;
    padding: 3px 0;
    transition: color 0.2s;
    font-family: 'Inter', sans-serif;
  }
  .footer-link:hover { color: var(--accent); }
  .footer-bottom {
    text-align: center;
    padding-top: 20px;
    border-top: 1px solid var(--border);
    font-size: 0.82rem;
    color: var(--text-dim);
  }

  /* ── Scrollbar ────────────────────────────────── */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 4px; }

  /* ── Animations ───────────────────────────────── */
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(20px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  .fade-in { animation: fadeInUp 0.5s ease forwards; }

  /* ── Toggle details ───────────────────────────── */
  details {
    margin: 12px 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
  }
  details summary {
    padding: 14px 20px;
    cursor: pointer;
    font-weight: 600;
    color: var(--accent);
    user-select: none;
    transition: background 0.2s;
  }
  details summary:hover { background: var(--surface2); }
  details[open] summary { border-bottom: 1px solid var(--border); }
  details .inner { padding: 16px 20px; }

  /* ── Mobile ───────────────────────────────────── */
  @media (max-width: 700px) {
    .nav-hamburger { display: flex; }
    .nav-links {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      flex-direction: column;
      background: rgba(10,14,26,0.96);
      border-top: 1px solid var(--border);
      padding: 8px 0;
      gap: 0;
    }
    .nav-links.open { display: flex; }
    .nav-links .nav-link {
      padding: 10px 24px;
      font-size: 0.88rem;
      border-radius: 0;
    }
    .nav-links .nav-link:hover { background: var(--surface2); }
    .nav-title { font-size: 0.82rem; }
    .playground-grid { grid-template-columns: 1fr; }
    .controls {
      flex-direction: column;
      align-items: stretch;
    }
    .controls .control-group { width: 100%; }
    .controls select, .controls button, .controls input[type="number"] { width: 100%; }
    .pipeline { flex-direction: column; align-items: stretch; }
    .pipe-arrow { transform: rotate(90deg); text-align: center; padding: 4px 0; }
    .pipe-step { min-width: auto; }
    .hero { padding: 50px 16px 40px; }
    .hero h1 { font-size: 1.8rem; }
    .math-block { font-size: 1rem; padding: 14px 16px; }
    .bar-chart { height: 150px; }
    section { padding: 36px 0; }
    #walkthrough-steps .wt-step { padding: 14px 16px; }
    #circle-svg { max-width: 320px; }
    .glossary .glossary-tip {
      position: fixed;
      bottom: 16px;
      left: 16px;
      right: 16px;
      top: auto;
      transform: none;
      max-width: none;
      width: auto;
    }
    .failure-compare { grid-template-columns: 1fr !important; }
    .footer-grid { grid-template-columns: 1fr; gap: 20px; }
  }
  @media (max-width: 480px) {
    .hero h1 { font-size: 1.5rem; }
    .container { padding: 0 16px; }
    .bar { width: 12px; }
    .bar-group { min-width: 16px; }
  }

  /* ── Reduced Motion ──────────────────────────── */
  @media (prefers-reduced-motion: reduce) {
    #walkthrough-steps .wt-step {
      transition: none;
      opacity: 1;
      transform: none;
    }
    .wt-enter, .wt-enter-active, .wt-exit, .wt-exit-active {
      transition: none !important;
      opacity: 1 !important;
      transform: none !important;
    }
    .bar { transition: none !important; }
    .gcd-step-line { transition: none; opacity: 1; transform: none; }
    .fade-in { animation: none; opacity: 1; transform: none; }
    .progress-dot { transition: none; }
    .batch-spinner { animation: none; }
    html { scroll-behavior: auto; }
    .bar, #circle-svg .node-group, #circle-svg .arrow-path,
    .gcd-step-line, #walkthrough-steps .wt-step { will-change: auto; }
  }

  /* ── Failure case comparison ──────────────────── */
  .failure-compare {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin: 16px 0;
  }
  .failure-compare .fc-case {
    background: var(--surface);
    border-radius: var(--radius);
    padding: 18px 20px;
    border: 1px solid var(--border);
  }
  .failure-compare .fc-fail { border-color: var(--red); }
  .failure-compare .fc-pass { border-color: var(--green); }
  .failure-compare .fc-title {
    font-weight: 700;
    font-size: 1rem;
    margin-bottom: 10px;
  }
  .failure-compare .fc-fail .fc-title { color: var(--red); }
  .failure-compare .fc-pass .fc-title { color: var(--green); }
  .failure-compare .fc-row {
    display: flex;
    justify-content: space-between;
    padding: 4px 0;
    font-size: 0.9rem;
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .failure-compare .fc-row:last-child { border-bottom: none; }
  .failure-compare .fc-label { color: var(--text-dim); }

  /* ── Animated step transitions ────────────────── */
  .wt-enter {
    opacity: 0;
    transform: translateX(20px);
  }
  .wt-enter-active {
    opacity: 1;
    transform: translateX(0);
    transition: opacity 0.3s ease, transform 0.3s ease;
  }
  .wt-exit {
    opacity: 1;
    transform: translateX(0);
  }
  .wt-exit-active {
    opacity: 0;
    transform: translateX(-20px);
    transition: opacity 0.25s ease, transform 0.25s ease;
  }

  /* ── Batch progress bar ───────────────────────── */
  .batch-progress {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    height: 28px;
    margin: 16px 0;
    position: relative;
  }
  .batch-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--accent), var(--cyan));
    border-radius: 8px;
    transition: width 0.15s ease;
  }
  .batch-progress-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 0.82rem;
    font-weight: 600;
    color: var(--text);
    text-shadow: 0 1px 3px rgba(0,0,0,0.5);
  }

  /* ── Keyboard Help Overlay ───────────────────── */
  .kbd-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    z-index: 2000;
    background: rgba(0, 0, 0, 0.6);
    align-items: center;
    justify-content: center;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }
  .kbd-overlay.open { display: flex; }
  .kbd-overlay-inner {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 24px 28px;
    max-width: 380px;
    width: 90%;
  }
  .kbd-overlay-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }
  .kbd-row {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 0;
    font-size: 0.92rem;
    color: var(--text-dim);
    border-bottom: 1px solid var(--border);
  }
  .kbd-row:last-of-type { border-bottom: none; }
  kbd {
    display: inline-block;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 2px 8px;
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.82rem;
    color: var(--text);
    min-width: 28px;
    text-align: center;
  }

  /* ── Speed Control ────────────────────────────── */
  .speed-control {
    display: inline-flex;
    border-radius: 6px;
    overflow: hidden;
    border: 1px solid var(--border);
  }
  .speed-btn {
    background: var(--surface2);
    border: none;
    border-right: 1px solid var(--border);
    color: var(--text-dim);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.45rem 0.65rem;
    cursor: pointer;
    transition: all 0.2s;
    border-radius: 0;
    letter-spacing: 0;
  }
  .speed-btn:last-child { border-right: none; }
  .speed-btn:hover {
    background: rgba(99, 102, 241, 0.1);
    color: var(--text);
    transform: none;
    box-shadow: none;
  }
  .speed-btn.active {
    background: rgba(99, 102, 241, 0.2);
    color: var(--accent);
    transform: none;
    box-shadow: none;
  }

  /* ── Sortable Table ────────────────────────────── */
  .seq-table th.sortable {
    cursor: pointer;
    user-select: none;
    position: relative;
    padding-right: 22px;
  }
  .seq-table th.sortable:hover { color: var(--text); }
  .seq-table th.sortable::after {
    content: '\2195';
    position: absolute;
    right: 6px;
    font-size: 0.72rem;
    opacity: 0.4;
  }
  .seq-table th.sortable.sort-asc::after {
    content: '\25B2';
    opacity: 0.9;
    color: var(--accent);
  }
  .seq-table th.sortable.sort-desc::after {
    content: '\25BC';
    opacity: 0.9;
    color: var(--accent);
  }

  /* ── Complexity Table ──────────────────────────── */
  .complexity-table td, .complexity-table th {
    font-size: 0.85rem;
    padding: 8px 12px;
  }
</style>
</head>
<body>

<canvas id="particleBg"></canvas>
<a href="../index.html" style="position:fixed;top:1.2rem;left:1.5rem;z-index:1000;display:inline-flex;align-items:center;gap:0.4rem;color:var(--text-dim,#8892a8);text-decoration:none;font-family:'Inter',sans-serif;font-size:0.85rem;font-weight:500;padding:0.4rem 0.8rem;border-radius:8px;background:rgba(17,24,39,0.7);border:1px solid rgba(42,53,80,0.5);backdrop-filter:blur(8px);transition:all 0.2s;" onmouseover="this.style.color='#e2e8f0';this.style.borderColor='#6366f1'" onmouseout="this.style.color='#8892a8';this.style.borderColor='rgba(42,53,80,0.5)'"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>Course Home</a>

<a href="#sec-big-picture" class="skip-link">Skip to content</a>

<!-- ── Sticky Nav ─────────────────────────────────────────── -->
<nav id="sticky-nav">
  <div id="scroll-progress"></div>
  <div class="nav-inner">
    <span class="nav-title">Factoring &rarr; Period Finding</span>
    <button class="nav-hamburger" id="nav-hamburger" aria-label="Toggle navigation menu" aria-expanded="false" aria-controls="nav-links">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
    <div class="nav-links" id="nav-links">
      <a href="#sec-big-picture" class="nav-link">Overview</a>
      <a href="#sec-setup" class="nav-link">Setup</a>
      <a href="#sec-reduction" class="nav-link">Reduction</a>
      <a href="#sec-explorer" class="nav-link">Explorer</a>
      <a href="#sec-batch" class="nav-link">Batch</a>
      <a href="#sec-quantum" class="nav-link">Why Quantum</a>
      <a href="#sec-quiz" class="nav-link">Quiz</a>
    </div>
  </div>
</nav>

<!-- ════════════════════════════════════════════════════════ -->
<header class="hero">
  <h1>Factoring &rarr; Period Finding</h1>
  <p>The classical reduction at the heart of Shor's algorithm — why finding the period of modular exponentiation lets us factor integers.</p>
</header>

<!-- ════════════════ §0  Big Picture ═══════════════════════ -->
<section id="sec-big-picture">
<div class="container">
  <h2>The Big Picture</h2>
  <p>
    Shor's algorithm factors a composite integer <span class="math">N</span> in two stages:
  </p>
  <div class="card card-accent">
    <p style="margin:0">
      <strong style="color:var(--accent)">1. Classical reduction</strong> — convert factoring into finding the <em>period</em> of the function
      <span class="math">f(x) = a<sup>x</sup> mod N</span>.
    </p>
    <p style="margin:10px 0 0">
      <strong style="color:var(--accent2)">2. Quantum subroutine</strong> — use quantum phase estimation to find that period efficiently.
    </p>
  </div>
  <p>
    This page focuses entirely on <strong>stage 1</strong>: the purely classical, number-theoretic argument that
    transforms a factoring problem into a period-finding problem. No quantum mechanics needed here —
    just modular arithmetic and one key insight about the multiplicative group mod <span class="math">N</span>.
  </p>
</div>
</section>

<!-- ════════════════ §1  Setup ═════════════════════════════ -->
<section id="sec-setup">
<div class="container">
  <h2><span class="step-num">1</span> Setup</h2>
  <p>We are given a composite odd integer <span class="math">N</span> that we want to factor. We may assume:</p>
  <ul>
    <li><span class="math">N</span> is <strong>not</strong> a prime power (we can check this classically in polynomial time).</li>
    <li><span class="math">N</span> is odd (factor out all 2's first).</li>
  </ul>
  <p>The strategy: pick a random integer <span class="math">a</span> with 1 &lt; <span class="math">a</span> &lt; <span class="math">N</span>
     and use it to probe the structure of <span class="math">N</span>. We check that <span class="math">a</span> is <span class="glossary" tabindex="0" aria-describedby="glossary-coprime">coprime<span class="glossary-tip" id="glossary-coprime" role="tooltip">Two integers are coprime if their greatest common divisor (gcd) equals 1, meaning they share no prime factors.</span></span> to <span class="math">N</span>.</p>

  <div class="math-block">
    f(x) = a<sup> x</sup> mod N
  </div>

  <p>Because the set {1, 2, &hellip;, N&minus;1} with gcd(<span class="math">a</span>, <span class="math">N</span>) = 1 forms a <span class="glossary" tabindex="0" aria-describedby="glossary-finite-group"><em>finite group</em><span class="glossary-tip" id="glossary-finite-group" role="tooltip">The multiplicative group mod N: the set of integers from 1 to N&minus;1 that are coprime to N, with multiplication mod N as the operation.</span></span> under multiplication mod <span class="math">N</span>,
     the sequence a<sup>0</sup>, a<sup>1</sup>, a<sup>2</sup>, &hellip; (mod <span class="math">N</span>) must eventually cycle. The length of that cycle is the <span class="glossary" tabindex="0" aria-describedby="glossary-order"><strong>order</strong><span class="glossary-tip" id="glossary-order" role="tooltip">The order (or period) of a modulo N is the smallest positive integer r such that a<sup>r</sup> &equiv; 1 (mod N).</span></span> (or <strong>period</strong>) <span class="math">r</span> of <span class="math">a</span> modulo <span class="math">N</span>.</p>

  <div class="math-block">
    a<sup> r</sup> &equiv; 1 (mod N), &ensp; r &gt; 0 minimal
  </div>
</div>
</section>

<!-- ════════════════ §2  The Reduction (Theory) ════════════ -->
<section id="sec-reduction">
<div class="container">
  <h2><span class="step-num">2</span> The Reduction — Why Period Finding Gives Factors</h2>

  <p>Suppose we have found the period <span class="math">r</span>. Then:</p>

  <div class="math-block">
    a<sup> r</sup> &minus; 1 &equiv; 0 (mod N)
  </div>

  <p>If <span class="math">r</span> is <strong>even</strong>, we can write this as a <span class="glossary" tabindex="0" aria-describedby="glossary-diff-squares">difference of squares<span class="glossary-tip" id="glossary-diff-squares" role="tooltip">The algebraic identity a&sup2; &minus; b&sup2; = (a &minus; b)(a + b). Here applied with a = a<sup>r/2</sup> and b = 1.</span></span>:</p>

  <div class="math-block">
    (a<sup> r/2</sup> &minus; 1)(a<sup> r/2</sup> + 1) &equiv; 0 (mod N)
  </div>

  <p>This means <span class="math">N</span> divides the product (a<sup>r/2</sup> &minus; 1)(a<sup>r/2</sup> + 1).
     If neither factor is itself divisible by <span class="math">N</span>, then <span class="math">N</span> must share a non-trivial factor with each one. We extract those factors with the <span class="glossary" tabindex="0" aria-describedby="glossary-euclidean">Euclidean algorithm<span class="glossary-tip" id="glossary-euclidean" role="tooltip">An efficient method for computing the greatest common divisor of two integers, running in O(log N) time &mdash; very fast even for large numbers.</span></span>:</p>

  <div class="math-block">
    gcd(a<sup> r/2</sup> &minus; 1, N) &ensp; and &ensp; gcd(a<sup> r/2</sup> + 1, N)
  </div>

  <div class="card card-warn">
    <span class="tag tag-warn">Failure conditions</span>
    <p style="margin:0">The method fails when:</p>
    <ul style="margin-top:8px">
      <li><span class="math">r</span> is <strong>odd</strong> — we cannot form the difference of squares.</li>
      <li><span class="math">a<sup>r/2</sup> &equiv; &minus;1</span> (mod <span class="math">N</span>) — then (a<sup>r/2</sup> + 1) is divisible by <span class="math">N</span>, giving the trivial factor.</li>
    </ul>
    <p style="margin:10px 0 0">In these cases we simply <strong>pick a new random</strong> <span class="math">a</span> and try again.</p>
  </div>

  <div class="failure-compare">
    <div class="fc-case fc-fail">
      <div class="fc-title">Fails: a = 14, N = 15</div>
      <div class="fc-row"><span class="fc-label">Period r</span><span class="mono">2</span></div>
      <div class="fc-row"><span class="fc-label">a<sup>r/2</sup> mod N</span><span class="mono">14<sup>1</sup> mod 15 = 14 &equiv; &minus;1</span></div>
      <div class="fc-row"><span class="fc-label">gcd(13, 15)</span><span class="mono">1 <span class="tag tag-warn" style="font-size:0.75rem">trivial</span></span></div>
      <div class="fc-row"><span class="fc-label">gcd(15, 15)</span><span class="mono">15 <span class="tag tag-warn" style="font-size:0.75rem">trivial</span></span></div>
    </div>
    <div class="fc-case fc-pass">
      <div class="fc-title">Succeeds: a = 2, N = 15</div>
      <div class="fc-row"><span class="fc-label">Period r</span><span class="mono">4</span></div>
      <div class="fc-row"><span class="fc-label">a<sup>r/2</sup> mod N</span><span class="mono">2<sup>2</sup> mod 15 = 4</span></div>
      <div class="fc-row"><span class="fc-label">gcd(3, 15)</span><span class="mono">3 <span class="tag tag-ok" style="font-size:0.75rem">factor!</span></span></div>
      <div class="fc-row"><span class="fc-label">gcd(5, 15)</span><span class="mono">5 <span class="tag tag-ok" style="font-size:0.75rem">factor!</span></span></div>
    </div>
  </div>

  <h3>Algorithm Pipeline</h3>
  <div class="pipeline" role="img" aria-label="Algorithm flowchart showing the steps of the factoring reduction">
    <div class="pipe-step pipe-step-start">
      <div class="pipe-label">Pick random a</div>
      <div class="pipe-detail">2 &le; a &le; N&minus;1</div>
    </div>
    <div class="pipe-arrow">&rarr;</div>
    <div class="pipe-step">
      <div class="pipe-label">gcd(a, N)</div>
      <div class="pipe-branch">
        <span class="pipe-tag pipe-tag-lucky">&gt; 1: Lucky!</span>
        <span class="pipe-tag pipe-tag-ok">= 1: continue</span>
      </div>
    </div>
    <div class="pipe-arrow">&rarr;</div>
    <div class="pipe-step">
      <div class="pipe-label">Find period r</div>
      <div class="pipe-detail">a<sup>r</sup> &equiv; 1 (mod N)</div>
    </div>
    <div class="pipe-arrow">&rarr;</div>
    <div class="pipe-step">
      <div class="pipe-label">r even?</div>
      <div class="pipe-branch">
        <span class="pipe-tag pipe-tag-fail">Odd: retry</span>
        <span class="pipe-tag pipe-tag-ok">Even: continue</span>
      </div>
    </div>
    <div class="pipe-arrow">&rarr;</div>
    <div class="pipe-step">
      <div class="pipe-label">a<sup>r/2</sup> &equiv; &minus;1?</div>
      <div class="pipe-branch">
        <span class="pipe-tag pipe-tag-fail">Yes: retry</span>
        <span class="pipe-tag pipe-tag-ok">No: continue</span>
      </div>
    </div>
    <div class="pipe-arrow">&rarr;</div>
    <div class="pipe-step pipe-step-end">
      <div class="pipe-label">Extract factors</div>
      <div class="pipe-detail">gcd(a<sup>r/2</sup> &plusmn; 1, N)</div>
    </div>
  </div>

  <details>
    <summary>Why does this succeed with high probability?</summary>
    <div class="inner">
      <p>One can show (using the <span class="glossary" tabindex="0" aria-describedby="glossary-crt">Chinese Remainder Theorem<span class="glossary-tip" id="glossary-crt" role="tooltip">A theorem that describes the structure of the group &#8484;/N&#8484; when N factors as a product of coprimes: the group splits as a direct product.</span></span>) that for a random <span class="math">a</span> coprime to <span class="math">N</span>,
        the probability that <span class="math">r</span> is even <em>and</em> a<sup>r/2</sup> &#8802; &minus;1 (mod N)
        is <strong>at least 1 &minus; 1/2<sup>k&minus;1</sup></strong>, where <span class="math">k</span> is the number of distinct prime factors of <span class="math">N</span>.
      </p>
      <p>For the simplest case, <span class="math">N = pq</span> (two distinct primes), the success probability is at least <strong>1/2</strong>.
        After a few random tries, we factor <span class="math">N</span> with overwhelming probability.</p>
    </div>
  </details>

  <details>
    <summary>The complete algorithm (pseudocode)</summary>
    <div class="inner">
      <pre style="color:var(--text);font-size:0.88rem;line-height:1.7;overflow-x:auto"><code>function FACTOR(N):
    if N is even: return 2
    if N = a^b for some a, b &ge; 2: return a
    repeat:
        pick random a &isin; {2, &hellip;, N&minus;1}
        g &larr; gcd(a, N)
        if g &gt; 1: return g          // lucky: a shares a factor
        r &larr; FIND_ORDER(a, N)        // &larr; quantum subroutine
        if r is odd: continue
        if a^(r/2) &equiv; &minus;1 (mod N): continue
        p &larr; gcd(a^(r/2) &minus; 1, N)
        q &larr; gcd(a^(r/2) + 1, N)
        return p, q</code></pre>
    </div>
  </details>
</div>
</section>

<!-- ════════════════ §3  Interactive Explorer ══════════════ -->
<section id="sec-explorer">
<div class="container">
  <h2><span class="step-num">3</span> Interactive Explorer</h2>
  <p>Choose an <span class="math">N</span> to factor and a base <span class="math">a</span>, then step through the reduction one step at a time.</p>

  <div class="controls">
    <div class="control-group">
      <label>N (to factor)</label>
      <select id="sel-n" aria-label="Choose N to factor">
        <option value="15">15 = 3 &times; 5</option>
        <option value="21">21 = 3 &times; 7</option>
        <option value="33">33 = 3 &times; 11</option>
        <option value="35">35 = 5 &times; 7</option>
        <option value="55">55 = 5 &times; 11</option>
        <option value="77">77 = 7 &times; 11</option>
        <option value="91">91 = 7 &times; 13</option>
        <option value="143">143 = 11 &times; 13</option>
        <option value="221">221 = 13 &times; 17</option>
      </select>
      <div id="custom-n-area">
        <div class="custom-n-row">
          <input type="number" id="input-custom-n" min="9" max="10000" placeholder="e.g. 299" aria-label="Custom value of N">
          <button class="sm" id="btn-apply-n">Apply</button>
          <button class="sm" id="btn-preset-n">Presets</button>
        </div>
        <div id="custom-n-error" role="alert" aria-live="assertive"></div>
        <div id="custom-n-info" role="status" aria-live="polite"></div>
      </div>
      <button class="sm" id="btn-custom-n" style="margin-top:4px">Custom N&hellip;</button>
    </div>
    <div class="control-group">
      <label>a (random base)</label>
      <select id="sel-a" aria-label="Choose base a"></select>
    </div>
    <button class="primary" id="btn-run" aria-label="Run the factoring reduction">Run Reduction</button>
    <button id="btn-random">Random <span class="math">a</span></button>
  </div>

  <!-- Walkthrough steps -->
  <div id="walkthrough-steps"></div>

  <!-- Step controls -->
  <div id="step-controls">
    <div class="step-controls-inner">
      <button id="btn-prev-step" disabled aria-label="Go to previous step">&larr; Prev</button>
      <button class="primary" id="btn-next-step" aria-label="Advance to next step">Next Step &rarr;</button>
      <button id="btn-skip-all">Show All</button>
      <button id="btn-reset" style="display:none">Reset</button>
      <span id="step-counter"></span>
      <div class="speed-control" id="speed-control" style="display:none">
        <button class="speed-btn" data-speed="1800">0.5&times;</button>
        <button class="speed-btn active" data-speed="900">1&times;</button>
        <button class="speed-btn" data-speed="400">2&times;</button>
      </div>
    </div>
    <div class="progress-dots" id="progress-dots"></div>
  </div>

  <!-- Chart -->
  <div class="chart-container" id="chart-container" style="display:none" role="img" aria-label="Bar chart of modular exponentiation sequence">
    <div class="chart-label">f(x) = <span id="chart-a">a</span><sup>x</sup> mod <span id="chart-n">N</span></div>
    <div class="bar-chart" id="bar-chart"></div>
    <div style="margin-top: 50px; font-size:0.82rem; color:var(--text-dim)">
      Hover over bars to see values. Repeating colour bands show the period.
    </div>
  </div>

  <!-- Circle visualization -->
  <div class="chart-container" id="circle-container" style="display:none" role="img" aria-label="Cyclic orbit visualization">
    <div class="chart-label">Cyclic orbit of <span id="circle-a">a</span> in &#8484;<sub><span id="circle-n">N</span></sub>*</div>
    <svg id="circle-svg" width="420" height="420" viewBox="0 0 420 420"></svg>
    <div style="margin-top:12px; font-size:0.82rem; color:var(--text-dim)">
      The sequence a<sup>0</sup> &rarr; a<sup>1</sup> &rarr; &hellip; &rarr; a<sup>r&minus;1</sup> &rarr; a<sup>0</sup> forms a cycle of length <span class="math">r</span>.
    </div>
  </div>

  <!-- Sequence table -->
  <div id="seq-table-area" style="display:none">
    <h3>Modular Exponentiation Sequence</h3>
    <div class="seq-table-wrap">
      <table class="seq-table" id="seq-table">
        <thead><tr><th>x</th><th>a<sup>x</sup> mod N</th><th>Period position</th></tr></thead>
        <tbody id="seq-tbody"></tbody>
      </table>
    </div>
  </div>

  <!-- Result -->
  <div id="result-area" role="status" aria-live="polite"></div>
</div>
</section>

<!-- ════════════════ §4  Batch Exploration ═════════════════ -->
<section id="sec-batch">
<div class="container">
  <h2><span class="step-num">4</span> Batch Exploration</h2>
  <p>See which values of <span class="math">a</span> succeed and which fail for a given <span class="math">N</span>. This builds intuition for why random selection works.</p>

  <div class="controls">
    <div class="control-group">
      <label>N</label>
      <select id="batch-n" aria-label="Choose N for batch analysis">
        <option value="15">15</option>
        <option value="21">21</option>
        <option value="33">33</option>
        <option value="35">35</option>
        <option value="55">55</option>
        <option value="77">77</option>
        <option value="91">91</option>
        <option value="143">143</option>
        <option value="221">221</option>
      </select>
    </div>
    <button class="primary" id="btn-batch" aria-label="Analyze all bases for chosen N">Analyze All Bases</button>
  </div>

  <div id="batch-results" role="status" aria-live="polite"></div>
</div>
</section>

<!-- ════════════════ §5  Why Quantum? ═════════════════════ -->
<section id="sec-quantum">
<div class="container">
  <h2><span class="step-num">5</span> Why Do We Need a Quantum Computer?</h2>
  <p>The reduction itself is classical — but the period-finding step is the bottleneck.</p>

  <div class="playground-grid">
    <div class="card">
      <span class="tag tag-warn">Classical</span>
      <p>Classically, finding the order of <span class="math">a</span> mod <span class="math">N</span> requires computing a<sup>1</sup>, a<sup>2</sup>, &hellip;, a<sup>r</sup> mod <span class="math">N</span>. Since <span class="math">r</span> can be as large as <span class="math">N</span>, this takes <strong>exponential time</strong> in the number of digits of <span class="math">N</span>.</p>
    </div>
    <div class="card">
      <span class="tag tag-ok">Quantum</span>
      <p>The quantum phase estimation algorithm creates a superposition of all x values simultaneously, applies modular exponentiation as a unitary, and reads off the period via the Quantum Fourier Transform — all in <strong>polynomial time</strong> (O(n<sup>3</sup>) for n-bit N).</p>
    </div>
  </div>

  <div class="card" style="margin-top:24px">
    <span class="tag tag-info">Key Insight</span>
    <p style="margin:0">The quantum speedup is not about factoring directly — it is about solving the <span class="glossary" tabindex="0" aria-describedby="glossary-hidden-subgroup"><em>hidden subgroup problem</em><span class="glossary-tip" id="glossary-hidden-subgroup" role="tooltip">Given a function on a group that is constant on cosets of an unknown subgroup, find that subgroup. Period finding is a special case over the integers.</span></span> over the integers modulo <span class="math">r</span>. The classical reduction reframes factoring as exactly this kind of structured period-finding problem, which quantum computers handle efficiently.</p>
  </div>

  <div class="card" style="margin-top:24px">
    <span class="tag tag-info">Scale Comparison</span>
    <p style="margin-bottom:14px">How long would period finding take at different input sizes, assuming 10<sup>9</sup> operations per second?</p>
    <div class="seq-table-wrap">
      <table class="seq-table complexity-table">
        <thead>
          <tr><th>Bits of N</th><th>N (approx)</th><th>Classical brute force</th><th>Quantum (Shor)</th></tr>
        </thead>
        <tbody>
          <tr><td>10</td><td>~10<sup>3</sup></td><td style="color:var(--green)">&lt; 1 ms</td><td style="color:var(--green)">&lt; 1 ms</td></tr>
          <tr><td>20</td><td>~10<sup>6</sup></td><td style="color:var(--green)">&lt; 1 sec</td><td style="color:var(--green)">&lt; 1 ms</td></tr>
          <tr><td>50</td><td>~10<sup>15</sup></td><td style="color:var(--orange)">~12 days</td><td style="color:var(--green)">&lt; 1 ms</td></tr>
          <tr><td>100</td><td>~10<sup>30</sup></td><td style="color:var(--red)">~10<sup>21</sup> years</td><td style="color:var(--green)">&lt; 1 sec</td></tr>
          <tr><td>2048</td><td>~10<sup>616</sup></td><td style="color:var(--red)">~10<sup>607</sup> years</td><td style="color:var(--green)">~minutes</td></tr>
        </tbody>
      </table>
    </div>
    <p style="font-size:0.82rem; color:var(--text-dim); margin:10px 0 0">
      Classical: O(N) = O(2<sup>n</sup>) steps to scan all possible periods.<br>
      Quantum: O(n<sup>3</sup>) gates where n = number of bits. Estimates are order-of-magnitude illustrations.
    </p>
  </div>
</div>
</section>

<!-- ════════════════ §6  Quiz ═════════════════════════════ -->
<section id="sec-quiz">
<div class="container">
  <h2><span class="step-num">6</span> Self-Check Quiz</h2>
  <p>Test your understanding of the factoring-to-period-finding reduction. Click an answer to check it.</p>
  <div id="quiz-container"></div>
  <div id="quiz-score" aria-live="polite"></div>
</div>
</section>

<!-- ════════════════ §7  Exercises ════════════════════════ -->
<section id="sec-exercises">
<div class="container">
  <h2><span class="step-num">7</span> Exercises</h2>
  <p>Use the Interactive Explorer and Batch Explorer above to investigate these questions.</p>

  <div class="card card-accent">
    <h3 style="margin-top:0">Exercise 1: The &minus;1 Failure</h3>
    <p>Set N = 15 and try base a = 14 in the Interactive Explorer (<a href="#" onclick="loadExplorer(15,14);return false" class="exercise-link">try N=15, a=14</a>). What happens? Now try a = 11 (<a href="#" onclick="loadExplorer(15,11);return false" class="exercise-link">try N=15, a=11</a>).
    Which failure condition does each one hit? Use the <a href="#" onclick="loadBatch(15);return false" class="exercise-link">Batch Explorer for N=15</a> and identify <em>all</em> bases that fail due to
    a<sup>r/2</sup> &equiv; &minus;1.</p>
    <details>
      <summary>Hint / Solution</summary>
      <div class="inner">
        <p>For a = 14: the order is r = 2 (even), but 14<sup>1</sup> mod 15 = 14 &equiv; &minus;1 (mod 15). This is the &minus;1 failure.
        For a = 11: the order is r = 2, and 11<sup>1</sup> mod 15 = 11 &ne; 14, so gcd(10, 15) = 5 and gcd(12, 15) = 3 — success!
        In the Batch Explorer, a = 4 and a = 14 are the only bases that fail via the &minus;1 condition. Notice 4 &equiv; &minus;11 and 14 &equiv; &minus;1 (mod 15).</p>
      </div>
    </details>
  </div>

  <div class="card card-accent">
    <h3 style="margin-top:0">Exercise 2: Period and Group Structure</h3>
    <p>For N = 21, use the <a href="#" onclick="loadBatch(21);return false" class="exercise-link">Batch Explorer for N=21</a> to find all bases that produce period r = 6.
    How many are there? <span class="glossary" tabindex="0" aria-describedby="glossary-euler-totient">Euler's totient<span class="glossary-tip" id="glossary-euler-totient" role="tooltip">&phi;(N) counts how many integers from 1 to N&minus;1 are coprime to N. For N = pq, &phi;(N) = (p&minus;1)(q&minus;1).</span></span> gives &phi;(21) = &phi;(3)&phi;(7) = 2 &times; 6 = 12.
    What is the relationship between the possible orders and &phi;(N)?</p>
    <details>
      <summary>Hint / Solution</summary>
      <div class="inner">
        <p>The possible orders must <em>divide</em> &phi;(N) = 12. So the possible orders are: 1, 2, 3, 4, 6, 12.
        Run the batch to see how many bases have each order. Bases with order 6 include a = 2, 5 among others.
        The number of elements of order d equals &phi;(d) in each cyclic subgroup, but the full group (&#8484;/21&#8484;)* &cong; &#8484;/2&#8484; &times; &#8484;/6&#8484; is not cyclic, so the distribution is richer.</p>
      </div>
    </details>
  </div>

  <div class="card card-accent">
    <h3 style="margin-top:0">Exercise 3: Scaling Up</h3>
    <p>Compare the success rates for <a href="#" onclick="loadBatch(15);return false" class="exercise-link">N=15</a>, <a href="#" onclick="loadBatch(77);return false" class="exercise-link">N=77</a>, and <a href="#" onclick="loadBatch(221);return false" class="exercise-link">N=221</a> using the Batch Explorer.
    Are they all above the theoretical 50% lower bound? Which N has the highest success rate, and can you guess why?</p>
    <details>
      <summary>Hint / Solution</summary>
      <div class="inner">
        <p>Run the Batch Explorer for each. All three exceed 50%. The success rate depends on the structure of p&minus;1 and q&minus;1:
        when these have few common factors, more random bases yield even orders with the non-trivial property.
        N = 77 = 7 &times; 11 has p&minus;1 = 6 and q&minus;1 = 10, with gcd(6,10) = 2.
        N = 221 = 13 &times; 17 has p&minus;1 = 12 and q&minus;1 = 16, with gcd(12,16) = 4, leading to relatively more failure cases.</p>
      </div>
    </details>
  </div>
</div>
</section>

<!-- ════════════════ Summary ══════════════════════════════ -->
<section id="sec-summary">
<div class="container">
  <h2>Summary</h2>
  <div class="card card-accent">
    <ol style="padding-left:20px; margin:0">
      <li style="color:var(--text); margin-bottom:10px"><strong>Pick</strong> a random base <span class="math">a</span> coprime to <span class="math">N</span>.</li>
      <li style="color:var(--text); margin-bottom:10px"><strong>Find</strong> the order <span class="math">r</span> of <span class="math">a</span> modulo <span class="math">N</span> (this is the hard step — use a quantum computer).</li>
      <li style="color:var(--text); margin-bottom:10px"><strong>Check</strong> that <span class="math">r</span> is even and a<sup>r/2</sup> &#8802; &minus;1 (mod <span class="math">N</span>). If not, retry with new <span class="math">a</span>.</li>
      <li style="color:var(--text); margin-bottom:0"><strong>Compute</strong> gcd(a<sup>r/2</sup> &plusmn; 1, <span class="math">N</span>) to get non-trivial factors.</li>
    </ol>
  </div>
  <p>Success probability per attempt: at least 50% for <span class="math">N = pq</span>. A handful of random attempts suffice.</p>
</div>
</section>



<!-- Keyboard Shortcut Help -->
<div id="kbd-help" class="kbd-overlay" role="dialog" aria-label="Keyboard shortcuts" aria-hidden="true">
  <div class="kbd-overlay-inner">
    <div class="kbd-overlay-header">
      <h3 style="margin:0; color:var(--text)">Keyboard Shortcuts</h3>
      <button class="sm" id="kbd-help-close" aria-label="Close">&times;</button>
    </div>
    <div class="kbd-row"><kbd>&rarr;</kbd> / <kbd>&darr;</kbd> <span>Next step</span></div>
    <div class="kbd-row"><kbd>&larr;</kbd> / <kbd>&uarr;</kbd> <span>Previous step</span></div>
    <div class="kbd-row"><kbd>?</kbd> <span>Toggle this help</span></div>
    <div class="kbd-row"><kbd>Esc</kbd> <span>Close overlay</span></div>
    <p style="color:var(--text-dim); font-size:0.82rem; margin:12px 0 0">Arrow keys work when the Explorer section is in view and no input is focused.</p>
  </div>
</div>

<!-- ══════════════════════════════════════════════════════════
     JAVASCRIPT
     ══════════════════════════════════════════════════════════ -->
<script>
// ── Math Utilities ─────────────────────────────────────────
function gcd(a, b) {
  a = Math.abs(a); b = Math.abs(b);
  while (b) { [a, b] = [b, a % b]; }
  return a;
}

function modpow(base, exp, mod) {
  let result = 1;
  base = ((base % mod) + mod) % mod;
  while (exp > 0) {
    if (exp % 2 === 1) result = (result * base) % mod;
    exp = Math.floor(exp / 2);
    base = (base * base) % mod;
  }
  return result;
}

function findOrder(a, N) {
  for (let r = 1; r <= N; r++) {
    if (modpow(a, r, N) === 1) return r;
  }
  return -1;
}

function getCoprimes(N) {
  const result = [];
  for (let a = 2; a < Math.min(N, 500); a++) {
    if (gcd(a, N) === 1) result.push(a);
  }
  return result;
}

function factorize(n) {
  const factors = [];
  let v = n;
  for (let p = 2; p * p <= v; p++) {
    while (v % p === 0) { factors.push(p); v /= p; }
  }
  if (v > 1) factors.push(v);
  return factors;
}

function isPrime(n) {
  if (n < 2) return false;
  if (n < 4) return true;
  if (n % 2 === 0 || n % 3 === 0) return false;
  for (let i = 5; i * i <= n; i += 6) {
    if (n % i === 0 || n % (i + 2) === 0) return false;
  }
  return true;
}

function isPrimePower(n) {
  for (let p = 2; p * p <= n; p++) {
    if (n % p === 0) {
      let val = p;
      while (val < n) val *= p;
      return val === n;
    }
  }
  return false;
}

function euclideanSteps(a, b) {
  const steps = [];
  a = Math.abs(a); b = Math.abs(b);
  if (a < b) [a, b] = [b, a];
  while (b > 0) {
    const q = Math.floor(a / b);
    const rem = a % b;
    steps.push({ a, b, q, rem });
    a = b;
    b = rem;
  }
  return { steps, result: a };
}

// ── Theme-aware helpers ────────────────────────────────────
function cssVar(name) {
  return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}
function hexToRgba(hex, alpha) {
  const r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${alpha})`;
}
function getPeriodColors() {
  return [
    cssVar('--accent'), cssVar('--accent2'), cssVar('--cyan'), cssVar('--orange'),
    cssVar('--green'), cssVar('--yellow'), cssVar('--red'), cssVar('--pink')
  ].map(c => hexToRgba(c, 0.82));
}

// ── DOM refs ───────────────────────────────────────────────
const selN = document.getElementById('sel-n');
const selA = document.getElementById('sel-a');
const btnRun = document.getElementById('btn-run');
const btnRandom = document.getElementById('btn-random');
const btnPrevStep = document.getElementById('btn-prev-step');
const btnNextStep = document.getElementById('btn-next-step');
const btnSkipAll = document.getElementById('btn-skip-all');
const btnReset = document.getElementById('btn-reset');
const stepControls = document.getElementById('step-controls');
const stepCounter = document.getElementById('step-counter');

const elWalkthroughSteps = document.getElementById('walkthrough-steps');
const elChartContainer   = document.getElementById('chart-container');
const elCircleContainer  = document.getElementById('circle-container');
const elSeqTableArea     = document.getElementById('seq-table-area');
const elResultArea       = document.getElementById('result-area');
const elProgressDots     = document.getElementById('progress-dots');
const elBarChart         = document.getElementById('bar-chart');
const elCircleSvg        = document.getElementById('circle-svg');
const elSeqTbody         = document.getElementById('seq-tbody');
const elChartA           = document.getElementById('chart-a');
const elChartN           = document.getElementById('chart-n');
const elCircleA          = document.getElementById('circle-a');
const elCircleN          = document.getElementById('circle-n');

// ── Motion preference ──────────────────────────────────────
const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

// ── Current N (may come from preset or custom) ────────────
let currentN = parseInt(selN.value);

// ── Custom N logic ─────────────────────────────────────────
const btnCustomN = document.getElementById('btn-custom-n');
const customNArea = document.getElementById('custom-n-area');
const inputCustomN = document.getElementById('input-custom-n');
const btnApplyN = document.getElementById('btn-apply-n');
const btnPresetN = document.getElementById('btn-preset-n');
const customNError = document.getElementById('custom-n-error');
const customNInfo = document.getElementById('custom-n-info');

btnCustomN.addEventListener('click', () => {
  customNArea.style.display = 'block';
  btnCustomN.style.display = 'none';
  selN.style.display = 'none';
});

btnPresetN.addEventListener('click', () => {
  customNArea.style.display = 'none';
  btnCustomN.style.display = '';
  selN.style.display = '';
  currentN = parseInt(selN.value);
  populateBases();
  clearResults();
  customNError.textContent = '';
  customNInfo.textContent = '';
});

btnApplyN.addEventListener('click', applyCustomN);
inputCustomN.addEventListener('keydown', (e) => { if (e.key === 'Enter') applyCustomN(); });

function applyCustomN() {
  const n = parseInt(inputCustomN.value);
  customNError.textContent = '';
  customNInfo.textContent = '';

  if (isNaN(n) || n < 3) {
    customNError.textContent = 'Enter an integer of at least 3.'; return;
  }
  if (n > 10000) {
    customNError.textContent = 'N must be 10,000 or less. Larger values make the brute-force period search too slow for a browser demo.'; return;
  }
  if (n % 2 === 0) {
    customNError.textContent = 'N must be odd. Shor\u2019s algorithm first divides out all factors of 2, so the interesting case is always odd N.'; return;
  }
  if (isPrime(n)) {
    customNError.textContent = `${n} is prime \u2014 there is nothing to factor! Enter a composite number like ${n * 3} or ${n + 4 - (n + 4) % 2 + 1}.`; return;
  }
  if (isPrimePower(n)) {
    const base = factorize(n)[0];
    const exp = Math.round(Math.log(n) / Math.log(base));
    customNError.textContent = `${n} = ${base}^${exp} is a prime power. These are detected classically, so Shor\u2019s reduction is not needed. Try a product of distinct primes.`; return;
  }

  currentN = n;
  const f = factorize(n);
  customNInfo.textContent = `\u2713 Valid: ${n} = ${f.join(' \u00d7 ')} \u2014 ${f.length} prime factor${f.length > 1 ? 's' : ''}`;
  populateBases();
  clearResults();
}

// ── Populate base selector ─────────────────────────────────
function populateBases() {
  const N = currentN;
  selA.innerHTML = '';
  // coprimes first
  for (let a = 2; a < Math.min(N, 500); a++) {
    if (gcd(a, N) === 1) {
      const opt = document.createElement('option');
      opt.value = a;
      opt.textContent = a;
      selA.appendChild(opt);
    }
  }
  // non-coprimes with label
  for (let a = 2; a < Math.min(N, 500); a++) {
    const g = gcd(a, N);
    if (g > 1) {
      const opt = document.createElement('option');
      opt.value = a;
      opt.textContent = `${a}  (gcd = ${g}, lucky!)`;
      selA.appendChild(opt);
    }
  }
}

selN.addEventListener('change', () => {
  currentN = parseInt(selN.value);
  populateBases();
  clearResults();
});
populateBases();

btnRandom.addEventListener('click', () => {
  const opts = Array.from(selA.options).filter(o => !o.textContent.includes('lucky'));
  if (opts.length) {
    selA.value = opts[Math.floor(Math.random() * opts.length)].value;
  }
});

function clearResults() {
  autoPlaying = false;
  elWalkthroughSteps.innerHTML = '';
  elChartContainer.style.display = 'none';
  elCircleContainer.style.display = 'none';
  elSeqTableArea.style.display = 'none';
  elResultArea.innerHTML = '';
  stepControls.style.display = 'none';
  walkthroughState = null;
  btnPrevStep.disabled = true;
  btnNextStep.textContent = 'Next Step \u2192';
  btnNextStep.disabled = false;
  btnReset.style.display = 'none';
  btnSkipAll.style.display = '';
  btnSkipAll.textContent = '\u25B6 Auto';
  speedControl.style.display = 'none';
  elProgressDots.innerHTML = '';
}

btnReset.addEventListener('click', () => clearResults());

// ── Deep-link helpers for exercises ─────────────────────
function loadExplorer(n, a) {
  const nOption = selN.querySelector('option[value="' + n + '"]');
  if (nOption) {
    selN.value = n;
    currentN = n;
    customNArea.style.display = 'none';
    btnCustomN.style.display = '';
    selN.style.display = '';
  } else {
    btnCustomN.click();
    inputCustomN.value = n;
    applyCustomN();
  }
  populateBases();
  if (a !== undefined && a !== null) selA.value = a;
  document.getElementById('sec-explorer').scrollIntoView({ behavior: 'smooth' });
  clearResults();
  setTimeout(startReduction, 400);
}

function loadBatch(n) {
  document.getElementById('batch-n').value = n;
  document.getElementById('sec-batch').scrollIntoView({ behavior: 'smooth' });
  setTimeout(runBatch, 400);
}

// ══════════════════════════════════════════════════════════
// STEPPER — Step-by-step walkthrough
// ══════════════════════════════════════════════════════════
let walkthroughState = null;
let autoPlaying = false;
let playSpeed = 900;

// ── Speed control ──────────────────────────────────────────
const speedControl = document.getElementById('speed-control');
document.querySelectorAll('.speed-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.speed-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    playSpeed = parseInt(btn.dataset.speed);
  });
});

function sleep(ms) { return new Promise(r => setTimeout(r, ms)); }

async function startAutoPlay() {
  if (autoPlaying) { stopAutoPlay(); return; }
  if (!walkthroughState) return;
  autoPlaying = true;
  btnSkipAll.textContent = '\u23F8 Pause';
  speedControl.style.display = '';
  btnNextStep.disabled = true;
  btnPrevStep.disabled = true;

  while (autoPlaying && walkthroughState && walkthroughState.currentIndex < walkthroughState.steps.length - 1) {
    advanceStep();
    await sleep(playSpeed);
  }

  if (autoPlaying) stopAutoPlay();
}

function stopAutoPlay() {
  autoPlaying = false;
  btnSkipAll.textContent = '\u25B6 Auto';
  speedControl.style.display = 'none';
  if (walkthroughState) {
    btnNextStep.disabled = walkthroughState.currentIndex >= walkthroughState.steps.length - 1;
    updatePrevButton();
  }
}

btnRun.addEventListener('click', startReduction);
btnPrevStep.addEventListener('click', retreatStep);
btnNextStep.addEventListener('click', advanceStep);
btnSkipAll.addEventListener('click', startAutoPlay);

function buildAllSteps(a, N) {
  const steps = [];
  let sequence = null, r = null, halfpow = null, f1 = null, f2 = null;
  let outcome = 'success'; // 'lucky', 'fail-odd', 'fail-neg1', 'success'

  const g = gcd(a, N);
  if (g > 1) {
    steps.push({
      title: `Lucky! gcd(${a}, ${N}) = ${g}`,
      body: `We found a non-trivial factor before even computing the period! Since gcd(a, N) = ${g} &gt; 1, we have <strong class="mono">${N} = ${g} &times; ${N/g}</strong>.`,
      triggers: ['result']
    });
    return { steps, sequence: [], r: 0, halfpow: 0, f1: g, f2: N/g, outcome: 'lucky' };
  }

  steps.push({
    title: `Check gcd(${a}, ${N}) = 1`,
    body: `Good — <span class="math">a = ${a}</span> is coprime to <span class="math">N = ${N}</span>. We proceed to find the order.`,
    triggers: []
  });

  r = findOrder(a, N);
  sequence = [];
  for (let x = 0; x < Math.max(2 * r + 4, 20); x++) {
    sequence.push({ x, val: modpow(a, x, N) });
  }

  steps.push({
    title: `Compute the order of ${a} mod ${N}`,
    body: `The sequence ${a}<sup>0</sup>, ${a}<sup>1</sup>, ${a}<sup>2</sup>, &hellip; mod ${N} repeats with period <strong class="mono">r = ${r}</strong>.`,
    triggers: ['chart', 'circle', 'table']
  });

  if (r % 2 !== 0) {
    steps.push({
      title: `r = ${r} is odd — failure!`,
      body: `We cannot form the difference of squares when r is odd. Pick a new random <span class="math">a</span> and try again.`,
      triggers: ['result']
    });
    return { steps, sequence, r, halfpow: 0, f1: 0, f2: 0, outcome: 'fail-odd' };
  }

  steps.push({
    title: `r = ${r} is even \u2714`,
    body: `We can write a<sup>r</sup> &minus; 1 = (a<sup>r/2</sup> &minus; 1)(a<sup>r/2</sup> + 1).`,
    triggers: []
  });

  halfpow = modpow(a, r / 2, N);
  if (halfpow === N - 1) {
    steps.push({
      title: `a^(${r/2}) mod ${N} = ${halfpow} \u2261 \u22121 — failure!`,
      body: `Since ${a}<sup>${r/2}</sup> &equiv; &minus;1 (mod ${N}), the factor (a<sup>r/2</sup> + 1) is divisible by N, giving only the trivial factor. Try another base.`,
      triggers: ['result']
    });
    return { steps, sequence, r, halfpow, f1: 0, f2: 0, outcome: 'fail-neg1' };
  }

  steps.push({
    title: `${a}^(${r/2}) mod ${N} = ${halfpow} \u2262 \u22121 \u2714`,
    body: `Neither (a<sup>r/2</sup> &minus; 1) = ${halfpow - 1} nor (a<sup>r/2</sup> + 1) = ${halfpow + 1} is divisible by ${N}. We can extract factors!`,
    triggers: []
  });

  f1 = gcd(halfpow - 1, N);
  f2 = gcd(halfpow + 1, N);

  // Build GCD animation HTML
  const gcd1 = euclideanSteps(halfpow - 1, N);
  const gcd2 = euclideanSteps(halfpow + 1, N);
  function gcdHTML(label, val, N, info) {
    let html = `<div style="margin-bottom:6px"><strong>${label}</strong></div>`;
    html += `<div class="gcd-steps" data-gcd-animate>`;
    info.steps.forEach(s => {
      html += `<div class="gcd-step-line">${s.a} = ${s.q} &times; ${s.b} + <span class="remainder">${s.rem}</span></div>`;
    });
    html += `<div class="gcd-step-line final">&rarr; gcd = ${info.result}</div>`;
    html += `</div>`;
    return html;
  }

  steps.push({
    title: `Extract factors via GCD`,
    body: `gcd(${halfpow} &minus; 1, ${N}) = gcd(${halfpow-1}, ${N}) = <strong class="mono">${f1}</strong><br>
           gcd(${halfpow} + 1, ${N}) = gcd(${halfpow+1}, ${N}) = <strong class="mono">${f2}</strong>
           <details style="margin-top:12px"><summary>Show Euclidean algorithm steps</summary><div class="inner">
           ${gcdHTML(`gcd(${halfpow-1}, ${N})`, halfpow-1, N, gcd1)}
           <div style="height:12px"></div>
           ${gcdHTML(`gcd(${halfpow+1}, ${N})`, halfpow+1, N, gcd2)}
           </div></details>`,
    triggers: ['result']
  });

  return { steps, sequence, r, halfpow, f1, f2, outcome: 'success' };
}

function startReduction() {
  const N = currentN;
  const a = parseInt(selA.value);

  clearResults();

  const data = buildAllSteps(a, N);
  walkthroughState = { ...data, a, N, currentIndex: -1 };

  // Show step controls
  stepControls.style.display = 'block';
  btnNextStep.textContent = 'Next Step \u2192';
  btnNextStep.disabled = false;
  btnSkipAll.style.display = '';
  btnSkipAll.textContent = '\u25B6 Auto';
  updateStepCounter();
  buildProgressDots(data.steps.length);

  // Auto-advance to first step
  advanceStep();
}

function executeStepTriggers(step, ws) {
  if (step.triggers.includes('chart')) renderChart(ws.a, ws.N, ws.sequence, ws.r);
  if (step.triggers.includes('circle')) renderCircleViz(ws.a, ws.N, ws.r);
  if (step.triggers.includes('table')) renderTable(ws.sequence, ws.r);
  if (step.triggers.includes('result')) renderResult(ws);
  if (step.triggers.includes('result') || step.body.includes('data-gcd-animate')) {
    setTimeout(animateGCDLines, 200);
  }
}

function endOfWalkthrough() {
  btnNextStep.disabled = true;
  btnSkipAll.style.display = 'none';
  speedControl.style.display = 'none';
  autoPlaying = false;
  btnReset.style.display = '';
}

function advanceStep() {
  if (!walkthroughState) return;
  const ws = walkthroughState;
  ws.currentIndex++;

  // Add only the new step with enter animation
  const el = elWalkthroughSteps;
  // Mark previous active step as done
  const prevActive = el.querySelector('.wt-step.active');
  if (prevActive) {
    prevActive.classList.remove('active');
    prevActive.classList.add('done');
  }

  const step = ws.steps[ws.currentIndex];
  if (step) {
    const div = document.createElement('div');
    div.className = 'wt-step wt-enter';
    div.innerHTML = `<h4>${step.title}</h4><p>${step.body}</p>`;
    el.appendChild(div);
    requestAnimationFrame(() => requestAnimationFrame(() => {
      div.classList.remove('wt-enter');
      div.classList.add('wt-enter-active', 'active');
    }));
    executeStepTriggers(step, ws);
  }

  updateStepCounter();
  updatePrevButton();
  updateProgressDots();

  if (ws.currentIndex >= ws.steps.length - 1) {
    endOfWalkthrough();
  }
}

function showAllSteps() {
  if (!walkthroughState) return;
  const ws = walkthroughState;
  const el = elWalkthroughSteps;
  el.innerHTML = '';

  while (ws.currentIndex < ws.steps.length - 1) {
    ws.currentIndex++;
    const step = ws.steps[ws.currentIndex];
    executeStepTriggers(step, ws);
  }

  // Render all steps at once (no animation)
  ws.steps.forEach((s, i) => {
    const div = document.createElement('div');
    div.className = 'wt-step';
    div.innerHTML = `<h4>${s.title}</h4><p>${s.body}</p>`;
    el.appendChild(div);
    div.classList.add(i < ws.currentIndex ? 'done' : 'active');
  });

  updateStepCounter();
  updatePrevButton();
  updateProgressDots();
  endOfWalkthrough();
}

function renderWalkthroughState() {
  if (!walkthroughState) return;
  const ws = walkthroughState;
  const el = elWalkthroughSteps;
  el.innerHTML = '';

  ws.steps.forEach((s, i) => {
    if (i > ws.currentIndex) return;
    const div = document.createElement('div');
    div.className = 'wt-step';
    div.innerHTML = `<h4>${s.title}</h4><p>${s.body}</p>`;
    el.appendChild(div);
    const cls = i < ws.currentIndex ? 'done' : 'active';
    requestAnimationFrame(() => requestAnimationFrame(() => div.classList.add(cls)));
  });
}

function updateStepCounter() {
  if (!walkthroughState) return;
  const ws = walkthroughState;
  const cur = Math.min(ws.currentIndex + 1, ws.steps.length);
  stepCounter.textContent = `Step ${cur} of ${ws.steps.length}`;
}

function animateGCDLines() {
  document.querySelectorAll('.gcd-step-line:not(.visible)').forEach((line, i) => {
    if (prefersReducedMotion) line.classList.add('visible');
    else setTimeout(() => line.classList.add('visible'), i * 150);
  });
}

function retreatStep() {
  if (!walkthroughState || walkthroughState.currentIndex <= 0) return;
  const ws = walkthroughState;
  const el = elWalkthroughSteps;

  // Animate the last step out
  const lastStep = el.lastElementChild;
  if (lastStep) {
    lastStep.classList.remove('active', 'done');
    lastStep.classList.add('wt-exit');
    requestAnimationFrame(() => requestAnimationFrame(() => {
      lastStep.classList.add('wt-exit-active');
    }));
    setTimeout(() => {
      if (lastStep.parentNode) lastStep.remove();
      // Mark the new last step as active
      const newLast = el.lastElementChild;
      if (newLast) {
        newLast.classList.remove('done');
        newLast.classList.add('active');
      }
    }, 250);
  }

  ws.currentIndex--;

  // Determine which triggers are still visible
  const visibleTriggers = new Set();
  for (let i = 0; i <= ws.currentIndex; i++) {
    ws.steps[i].triggers.forEach(t => visibleTriggers.add(t));
  }
  if (!visibleTriggers.has('chart')) elChartContainer.style.display = 'none';
  if (!visibleTriggers.has('circle')) elCircleContainer.style.display = 'none';
  if (!visibleTriggers.has('table')) elSeqTableArea.style.display = 'none';
  if (!visibleTriggers.has('result')) elResultArea.innerHTML = '';

  updateStepCounter();
  updateProgressDots();

  // Restore Next/Reset buttons
  btnNextStep.disabled = false;
  btnReset.style.display = 'none';
  btnSkipAll.style.display = '';
  updatePrevButton();
}

function updatePrevButton() {
  btnPrevStep.disabled = !walkthroughState || walkthroughState.currentIndex <= 0;
}

function buildProgressDots(totalSteps) {
  const container = elProgressDots;
  container.innerHTML = '';
  for (let i = 0; i < totalSteps; i++) {
    const dot = document.createElement('div');
    dot.className = 'progress-dot';
    container.appendChild(dot);
  }
}

function updateProgressDots() {
  if (!walkthroughState) return;
  const dots = document.querySelectorAll('#progress-dots .progress-dot');
  dots.forEach((dot, i) => {
    dot.className = 'progress-dot';
    if (i < walkthroughState.currentIndex) dot.classList.add('done');
    else if (i === walkthroughState.currentIndex) dot.classList.add('active');
  });
}

function renderResult(ws) {
  if (ws.outcome === 'lucky') {
    renderLuckyResult(ws.a, ws.N, ws.f1);
  } else if (ws.outcome === 'fail-odd') {
    renderFailResult(`r = ${ws.r} is odd. The difference-of-squares factorization requires an even period. Try another base.`);
  } else if (ws.outcome === 'fail-neg1') {
    renderFailResult(`${ws.a}<sup>${ws.r/2}</sup> mod ${ws.N} = ${ws.halfpow} \u2261 \u22121 (mod ${ws.N}). The factor (a<sup>r/2</sup> + 1) is divisible by N. Try another base.`);
  } else {
    renderSuccessResult(ws.a, ws.N, ws.r, ws.halfpow, ws.f1, ws.f2);
  }
}

// ── Render Bar Chart ───────────────────────────────────────
function renderChart(a, N, seq, r) {
  elChartContainer.style.display = 'block';
  elChartA.textContent = a;
  elChartN.textContent = N;

  const chart = elBarChart;
  chart.innerHTML = '';
  chart.style.position = 'relative';

  const maxVal = N - 1;
  const barH = 160;
  const periodColors = getPeriodColors();

  seq.forEach((item, i) => {
    const group = document.createElement('div');
    group.className = 'bar-group';

    const bar = document.createElement('div');
    const h = Math.max(4, (item.val / maxVal) * barH);
    const colorIdx = Math.floor(item.x / r) % periodColors.length;
    bar.className = 'bar';
    bar.style.height = '0px';
    bar.style.background = periodColors[colorIdx];

    const valLabel = document.createElement('div');
    valLabel.className = 'bar-val';
    valLabel.textContent = item.val;

    const xLabel = document.createElement('div');
    xLabel.className = 'bar-x';
    xLabel.textContent = item.x;

    bar.appendChild(valLabel);
    group.appendChild(bar);
    group.appendChild(xLabel);
    chart.appendChild(group);

    if (prefersReducedMotion) { bar.style.height = h + 'px'; }
    else { setTimeout(() => { bar.style.height = h + 'px'; }, i * 35); }
  });

  setTimeout(() => {
    const groups = chart.querySelectorAll('.bar-group');
    if (groups.length < r) return;
    for (let start = 0; start + r <= seq.length; start += r) {
      const firstBar = groups[start];
      const lastBar = groups[start + r - 1];
      if (!firstBar || !lastBar) break;
      const left = firstBar.offsetLeft;
      const right = lastBar.offsetLeft + lastBar.offsetWidth;

      const bracket = document.createElement('div');
      bracket.className = 'period-bracket';
      bracket.style.left = left + 'px';
      bracket.style.width = (right - left) + 'px';
      chart.appendChild(bracket);

      if (start === 0) {
        const label = document.createElement('div');
        label.className = 'period-bracket-label';
        label.style.left = left + 'px';
        label.style.width = (right - left) + 'px';
        label.style.textAlign = 'center';
        label.textContent = `r = ${r}`;
        chart.appendChild(label);
      }
    }
  }, prefersReducedMotion ? 0 : seq.length * 35 + 100);
}

// ── Render Circle Visualization ────────────────────────────
function renderCircleViz(a, N, r) {
  elCircleContainer.style.display = 'block';
  elCircleA.textContent = a;
  elCircleN.textContent = N;

  const svg = elCircleSvg;
  svg.innerHTML = '';

  // Read theme colors once
  const cAccent = cssVar('--accent');
  const cBorder = cssVar('--border');
  const cSurface = cssVar('--surface');
  const cSurface2 = cssVar('--surface2');
  const cText = cssVar('--text');
  const cTextDim = cssVar('--text-dim');

  const ns = 'http://www.w3.org/2000/svg';
  const cx = 210, cy = 210, radius = 155;
  const nodeR = r <= 8 ? 22 : (r <= 14 ? 18 : 14);
  const fontSize = r <= 8 ? 13 : (r <= 14 ? 11 : 9);
  const expFontSize = r <= 8 ? 10 : 8;

  const values = [];
  for (let i = 0; i < r; i++) values.push(modpow(a, i, N));

  // Defs: arrowhead markers
  const defs = document.createElementNS(ns, 'defs');
  ['arrow-dim', 'arrow-accent'].forEach(id => {
    const marker = document.createElementNS(ns, 'marker');
    marker.setAttribute('id', id);
    marker.setAttribute('markerWidth', '8');
    marker.setAttribute('markerHeight', '6');
    marker.setAttribute('refX', '7');
    marker.setAttribute('refY', '3');
    marker.setAttribute('orient', 'auto');
    const poly = document.createElementNS(ns, 'polygon');
    poly.setAttribute('points', '0 0, 8 3, 0 6');
    poly.setAttribute('fill', id === 'arrow-accent' ? cAccent : cBorder);
    marker.appendChild(poly);
    defs.appendChild(marker);
  });
  svg.appendChild(defs);

  // Guide ring
  const guide = document.createElementNS(ns, 'circle');
  guide.setAttribute('cx', cx);
  guide.setAttribute('cy', cy);
  guide.setAttribute('r', radius);
  guide.setAttribute('fill', 'none');
  guide.setAttribute('stroke', cBorder);
  guide.setAttribute('stroke-width', '1');
  guide.setAttribute('stroke-dasharray', '4,4');
  svg.appendChild(guide);

  // Positions
  const positions = values.map((v, i) => {
    const angle = (i / r) * 2 * Math.PI - Math.PI / 2;
    return { x: cx + radius * Math.cos(angle), y: cy + radius * Math.sin(angle), val: v, exp: i };
  });

  // Arrows
  for (let i = 0; i < r; i++) {
    const from = positions[i];
    const to = positions[(i + 1) % r];
    const dx = to.x - from.x, dy = to.y - from.y;
    const dist = Math.sqrt(dx * dx + dy * dy);
    const ux = dx / dist, uy = dy / dist;
    const x1 = from.x + ux * (nodeR + 3);
    const y1 = from.y + uy * (nodeR + 3);
    const x2 = to.x - ux * (nodeR + 5);
    const y2 = to.y - uy * (nodeR + 5);

    const isReturn = (i === r - 1);
    const line = document.createElementNS(ns, 'line');
    line.setAttribute('x1', x1);
    line.setAttribute('y1', y1);
    line.setAttribute('x2', x2);
    line.setAttribute('y2', y2);
    line.setAttribute('stroke', isReturn ? cAccent : cBorder);
    line.setAttribute('stroke-width', isReturn ? '2.5' : '1.5');
    line.setAttribute('marker-end', `url(#${isReturn ? 'arrow-accent' : 'arrow-dim'})`);
    line.classList.add('arrow-path');
    svg.appendChild(line);

    if (prefersReducedMotion) line.classList.add('visible');
    else setTimeout(() => line.classList.add('visible'), i * 120 + 80);
  }

  // Nodes
  positions.forEach((p, i) => {
    const g = document.createElementNS(ns, 'g');
    g.classList.add('node-group');

    const circle = document.createElementNS(ns, 'circle');
    circle.setAttribute('cx', p.x);
    circle.setAttribute('cy', p.y);
    circle.setAttribute('r', nodeR);
    circle.setAttribute('fill', i === 0 ? cSurface2 : cSurface);
    circle.setAttribute('stroke', i === 0 ? cAccent : cBorder);
    circle.setAttribute('stroke-width', i === 0 ? '2.5' : '1.5');
    g.appendChild(circle);

    const text = document.createElementNS(ns, 'text');
    text.setAttribute('x', p.x);
    text.setAttribute('y', p.y + 1);
    text.setAttribute('text-anchor', 'middle');
    text.setAttribute('dominant-baseline', 'central');
    text.setAttribute('fill', i === 0 ? cAccent : cText);
    text.setAttribute('font-size', fontSize);
    text.textContent = p.val;
    g.appendChild(text);

    // Exponent label outside circle
    const angle = (i / r) * 2 * Math.PI - Math.PI / 2;
    const labelR = radius + nodeR + 10;
    const lx = cx + labelR * Math.cos(angle);
    const ly = cy + labelR * Math.sin(angle);
    const expLabel = document.createElementNS(ns, 'text');
    expLabel.setAttribute('x', lx);
    expLabel.setAttribute('y', ly);
    expLabel.setAttribute('text-anchor', 'middle');
    expLabel.setAttribute('dominant-baseline', 'central');
    expLabel.setAttribute('fill', cTextDim);
    expLabel.setAttribute('font-size', expFontSize);
    expLabel.textContent = `${a}^${i}`;
    g.appendChild(expLabel);

    svg.appendChild(g);
    if (prefersReducedMotion) g.classList.add('visible');
    else setTimeout(() => g.classList.add('visible'), i * 120);
  });
}

// ── Render Sequence Table ──────────────────────────────────
function renderTable(seq, r) {
  elSeqTableArea.style.display = 'block';
  const tbody = elSeqTbody;
  tbody.innerHTML = '';

  seq.forEach(item => {
    const tr = document.createElement('tr');
    const posInPeriod = item.x % r;
    const isStart = posInPeriod === 0 && item.x > 0;
    tr.innerHTML = `
      <td${isStart ? ' class="period-start"' : ''}>${item.x}</td>
      <td class="${posInPeriod === 0 ? 'highlight' : ''}">${item.val}</td>
      <td style="color:var(--text-dim)">${posInPeriod}${posInPeriod === 0 ? '  \u2190 cycle start' : ''}</td>
    `;
    tbody.appendChild(tr);
  });
}

// ── Render Results ─────────────────────────────────────────
function renderSuccessResult(a, N, r, halfpow, f1, f2) {
  const area = elResultArea;
  area.innerHTML = `
    <div class="result-box success fade-in">
      <div><span class="label">Success!</span> Factored ${N} using base a = ${a}</div>
      <div style="margin-top:10px">
        <div>Period r = ${r} (even \u2714)</div>
        <div>a<sup>r/2</sup> mod N = ${a}<sup>${r/2}</sup> mod ${N} = ${halfpow} (\u2262 \u22121 \u2714)</div>
        <div style="margin-top:8px; font-size:1.1rem">
          <strong>${N} = ${f1} \u00d7 ${f2}</strong>
        </div>
      </div>
    </div>
  `;
}

function renderFailResult(reason) {
  const area = elResultArea;
  area.innerHTML = `
    <div class="result-box fail fade-in">
      <div><span class="label">Failure</span> — must try a different base.</div>
      <div style="margin-top:8px">${reason}</div>
    </div>
  `;
}

function renderLuckyResult(a, N, g) {
  const area = elResultArea;
  area.innerHTML = `
    <div class="result-box info fade-in">
      <div><span class="label">Lucky!</span> gcd(${a}, ${N}) = ${g}</div>
      <div style="margin-top:8px">We found a factor without needing period finding at all. <strong>${N} = ${g} \u00d7 ${N/g}</strong></div>
    </div>
  `;
}

// ══════════════════════════════════════════════════════════
// BATCH EXPLORER
// ══════════════════════════════════════════════════════════
document.getElementById('btn-batch').addEventListener('click', runBatch);

const BATCH_TYPE_LABEL = {
  'lucky': '<span style="color:var(--cyan)">Lucky</span>',
  'success': '<span style="color:var(--green)">Success</span>',
  'fail-odd': '<span style="color:var(--red)">Fail (r odd)</span>',
  'fail-neg1': '<span style="color:var(--red)">Fail (\u22121)</span>',
};

function renderBatchResults(N, results, successCount, totalCoprime) {
  const area = document.getElementById('batch-results');
  const pct = totalCoprime > 0 ? ((successCount / totalCoprime) * 100).toFixed(1) : 0;
  const luckyCount = results.filter(r => r.type === 'lucky').length;
  const failOddCount = results.filter(r => r.type === 'fail-odd').length;
  const failNeg1Count = results.filter(r => r.type === 'fail-neg1').length;
  const total = results.length;

  const segments = [
    { count: successCount, color: 'var(--green)', label: `Success (${successCount})` },
    { count: luckyCount, color: 'var(--cyan)', label: `Lucky (${luckyCount})` },
    { count: failOddCount, color: 'var(--red)', label: `Odd r (${failOddCount})` },
    { count: failNeg1Count, color: 'var(--orange)', label: `\u22121 (${failNeg1Count})` },
  ];
  let barHTML = '<div class="outcome-bar">';
  segments.forEach(seg => {
    const segPct = total > 0 ? (seg.count / total) * 100 : 0;
    if (segPct > 0) {
      barHTML += `<div class="outcome-seg" style="width:${segPct}%;background:${seg.color}" title="${seg.label}">${segPct >= 8 ? Math.round(segPct) + '%' : ''}</div>`;
    }
  });
  barHTML += '</div><div class="outcome-legend">';
  segments.forEach(seg => {
    if (seg.count > 0) {
      barHTML += `<span class="outcome-legend-item"><span class="outcome-dot" style="background:${seg.color}"></span>${seg.label}</span>`;
    }
  });
  barHTML += '</div>';

  let html = `
    <div class="playground-grid" style="margin-top:20px">
      <div class="card">
        <span class="tag tag-info">Statistics for N = ${N}</span>
        <div class="stat"><span class="stat-label">Total bases tested</span><span class="stat-value">${N - 2}</span></div>
        <div class="stat"><span class="stat-label">Coprime bases (gcd=1)</span><span class="stat-value">${totalCoprime}</span></div>
        <div class="stat"><span class="stat-label">Successful reductions</span><span class="stat-value" style="color:var(--green)">${successCount}</span></div>
        <div class="stat"><span class="stat-label">Success rate (coprime)</span><span class="stat-value" style="color:var(--green)">${pct}%</span></div>
        <div class="stat"><span class="stat-label">Lucky (gcd &gt; 1)</span><span class="stat-value" style="color:var(--cyan)">${luckyCount}</span></div>
        <div class="stat"><span class="stat-label">Failed (r odd)</span><span class="stat-value" style="color:var(--red)">${failOddCount}</span></div>
        <div class="stat"><span class="stat-label">Failed (a^(r/2)\u2261\u22121)</span><span class="stat-value" style="color:var(--red)">${failNeg1Count}</span></div>
        ${barHTML}
      </div>
      <div class="card">
        <span class="tag tag-ok">Interpretation</span>
        <p>Out of ${totalCoprime} coprime bases, <strong>${successCount}</strong> (${pct}%) lead to a successful factorization of ${N}.</p>
        <p>This confirms that a <em>random</em> choice of <span class="math">a</span> has a good chance of working. The theoretical lower bound for N = pq is 50%.</p>
        <p style="color:var(--text-dim); font-size:0.88rem; margin:0">
          Prime factorization: ${N} = ${factorize(N).join(' \u00d7 ')}
        </p>
      </div>
    </div>
    <details style="margin-top:16px">
      <summary>Full table of all bases</summary>
      <div class="inner">
        <div class="seq-table-wrap">
          <table class="seq-table">
            <thead><tr><th class="sortable" data-sort="a">a</th><th class="sortable" data-sort="status">Status</th><th class="sortable" data-sort="detail">Detail</th></tr></thead>
            <tbody>`;

  results.forEach(r => {
    html += `<tr><td>${r.a}</td><td>${BATCH_TYPE_LABEL[r.type]}</td><td style="color:var(--text-dim);font-size:0.88rem">${r.detail}</td></tr>`;
  });

  html += `</tbody></table></div></div></details>`;
  area.innerHTML = html;
  initBatchSort(area, results);
}

function initBatchSort(area, results) {
  const table = area.querySelector('.seq-table');
  if (!table) return;
  const headers = table.querySelectorAll('th.sortable');
  let currentSort = { key: null, dir: 'asc' };
  const typeOrder = { 'lucky': 0, 'success': 1, 'fail-odd': 2, 'fail-neg1': 3 };

  headers.forEach(th => {
    th.addEventListener('click', () => {
      const key = th.dataset.sort;
      let dir = 'asc';
      if (currentSort.key === key && currentSort.dir === 'asc') dir = 'desc';
      currentSort = { key, dir };

      headers.forEach(h => h.classList.remove('sort-asc', 'sort-desc'));
      th.classList.add(dir === 'asc' ? 'sort-asc' : 'sort-desc');

      const sorted = [...results].sort((a, b) => {
        let va, vb;
        if (key === 'a') { va = a.a; vb = b.a; }
        else if (key === 'status') { va = typeOrder[a.type]; vb = typeOrder[b.type]; }
        else { va = a.detail; vb = b.detail; }
        if (typeof va === 'number') return dir === 'asc' ? va - vb : vb - va;
        return dir === 'asc' ? String(va).localeCompare(String(vb)) : String(vb).localeCompare(String(va));
      });

      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '';
      sorted.forEach(r => {
        tbody.innerHTML += `<tr><td>${r.a}</td><td>${BATCH_TYPE_LABEL[r.type]}</td><td style="color:var(--text-dim);font-size:0.88rem">${r.detail}</td></tr>`;
      });
    });
  });
}

let batchAbort = false;

async function runBatch() {
  const N = parseInt(document.getElementById('batch-n').value);
  const area = document.getElementById('batch-results');
  const batchBtn = document.getElementById('btn-batch');
  const totalBases = N - 2;
  const CHUNK = 50;
  batchAbort = false;

  batchBtn.disabled = true;
  area.innerHTML = `
    <div style="padding:24px">
      <div style="text-align:center; color:var(--text-dim); margin-bottom:8px">Analyzing all bases for N = ${N}&hellip;</div>
      <div class="batch-progress">
        <div class="batch-progress-fill" id="bp-fill" style="width:0%"></div>
        <div class="batch-progress-text" id="bp-text">0 / ${totalBases}</div>
      </div>
      <div style="text-align:center; margin-top:8px"><button class="sm" id="btn-batch-cancel">Cancel</button></div>
    </div>`;
  document.getElementById('btn-batch-cancel').addEventListener('click', () => { batchAbort = true; });

  const results = [];
  let successCount = 0;
  let totalCoprime = 0;
  let processed = 0;
  const fill = document.getElementById('bp-fill');
  const text = document.getElementById('bp-text');

  for (let start = 2; start < N; start += CHUNK) {
    const end = Math.min(start + CHUNK, N);
    for (let a = start; a < end; a++) {
      const g = gcd(a, N);
      if (g > 1) {
        results.push({ a, type: 'lucky', detail: `gcd(${a},${N})=${g}`, r: '-', factor: g });
        processed++;
        continue;
      }
      totalCoprime++;
      const r = findOrder(a, N);
      if (r % 2 !== 0) {
        results.push({ a, type: 'fail-odd', detail: `r=${r} (odd)`, r, factor: '-' });
        processed++;
        continue;
      }
      const hp = modpow(a, r / 2, N);
      if (hp === N - 1) {
        results.push({ a, type: 'fail-neg1', detail: `r=${r}, a^(r/2)\u2261\u22121`, r, factor: '-' });
        processed++;
        continue;
      }
      const f1 = gcd(hp - 1, N);
      const f2 = gcd(hp + 1, N);
      results.push({ a, type: 'success', detail: `r=${r}, factors: ${f1}\u00d7${f2}`, r, factor: `${f1}\u00d7${f2}` });
      successCount++;
      processed++;
    }
    // Update progress and yield to event loop
    const pctDone = (processed / totalBases) * 100;
    fill.style.width = pctDone + '%';
    text.textContent = `${processed} / ${totalBases}`;
    await new Promise(resolve => setTimeout(resolve, 0));
    if (batchAbort) {
      batchAbort = false;
      batchBtn.disabled = false;
      area.innerHTML = '<p style="color:var(--text-dim); padding:16px 0">Batch analysis cancelled.</p>';
      return;
    }
  }

  renderBatchResults(N, results, successCount, totalCoprime);
  batchBtn.disabled = false;
}

// ══════════════════════════════════════════════════════════
// QUIZ
// ══════════════════════════════════════════════════════════
const QUIZ_DATA = [
  {
    q: "Why must the period r be even for the reduction to work?",
    options: [
      "Because quantum phase estimation only returns even numbers",
      "Because we need to form the difference of squares (a^(r/2) \u2212 1)(a^(r/2) + 1)",
      "Because odd periods mean a is not coprime to N",
      "Because the group \u2124*\u2099 always has even order"
    ],
    correct: 1,
    explanation: "We rely on the factorization a\u02b3 \u2212 1 = (a^(r/2) \u2212 1)(a^(r/2) + 1). This difference-of-squares decomposition only works when r is even, so that r/2 is an integer."
  },
  {
    q: "If gcd(a, N) > 1 when we pick our random base a, what happens?",
    options: [
      "The algorithm fails and we must restart",
      "We found a factor of N immediately without needing period finding",
      "We must discard a and pick another base",
      "The period r will be 1"
    ],
    correct: 1,
    explanation: "If gcd(a, N) = g > 1, then g is already a non-trivial factor of N. This is the 'lucky' case \u2014 we stumbled onto a factor before even starting the quantum subroutine."
  },
  {
    q: "Why does a^(r/2) \u2261 \u22121 (mod N) cause the reduction to fail?",
    options: [
      "Because it means r is actually odd",
      "Because (a^(r/2) + 1) becomes divisible by N, giving only the trivial factor N",
      "Because it means a is not coprime to N",
      "Because the GCD algorithm cannot handle negative inputs"
    ],
    correct: 1,
    explanation: "When a^(r/2) \u2261 \u22121 (mod N), we get a^(r/2) + 1 \u2261 0 (mod N), so gcd(a^(r/2) + 1, N) = N \u2014 a trivial factor. The other GCD may also yield only 1 or N."
  },
  {
    q: "What is the minimum success probability per random attempt when N = pq (two distinct primes)?",
    options: [
      "25%",
      "50%",
      "75%",
      "It depends on the specific primes p and q"
    ],
    correct: 1,
    explanation: "By the Chinese Remainder Theorem argument, the probability is at least 1 \u2212 1/2^(k\u22121), where k is the number of distinct prime factors. For k = 2 (N = pq), this gives 1 \u2212 1/2 = 50%."
  }
];

function initQuiz() {
  const container = document.getElementById('quiz-container');
  const scoreEl = document.getElementById('quiz-score');
  container.innerHTML = '';
  scoreEl.style.display = 'none';
  scoreEl.innerHTML = '';
  let answered = 0, correct = 0;

  QUIZ_DATA.forEach((q, qi) => {
    const qDiv = document.createElement('div');
    qDiv.className = 'quiz-question';
    qDiv.innerHTML = `<div class="quiz-q-text">${qi + 1}. ${q.q}</div>`;

    q.options.forEach((opt, oi) => {
      const btn = document.createElement('button');
      btn.className = 'quiz-option';
      btn.textContent = opt;
      btn.addEventListener('click', () => {
        if (btn.classList.contains('answered')) return;

        const allBtns = qDiv.querySelectorAll('.quiz-option');
        allBtns.forEach((b, bi) => {
          b.classList.add('answered');
          if (bi === q.correct) b.classList.add('correct');
          else if (bi === oi && oi !== q.correct) b.classList.add('incorrect');
          else b.classList.add('dimmed');
        });

        answered++;
        if (oi === q.correct) correct++;

        const expl = qDiv.querySelector('.quiz-explanation');
        if (expl) setTimeout(() => expl.classList.add('open'), 150);

        scoreEl.style.display = 'block';
        let scoreHTML = `Score: <span style="color:var(--green)">${correct}</span> / ${answered}`;
        if (answered === QUIZ_DATA.length) {
          scoreHTML += `<span style="margin-left:12px; color:${correct === QUIZ_DATA.length ? 'var(--green)' : 'var(--text-dim)'}">${correct === QUIZ_DATA.length ? '\u2014 Perfect!' : ''}</span>`;
          scoreHTML += ` <button class="sm" onclick="initQuiz()" style="margin-left:12px">Retake Quiz</button>`;
        }
        scoreEl.innerHTML = scoreHTML;
      });
      qDiv.appendChild(btn);
    });

    const expl = document.createElement('div');
    expl.className = 'quiz-explanation';
    expl.textContent = q.explanation;
    qDiv.appendChild(expl);

    container.appendChild(qDiv);
  });
}
initQuiz();

// ══════════════════════════════════════════════════════════
// STICKY NAV + SCROLL PROGRESS
// ══════════════════════════════════════════════════════════
(function initNav() {
  const nav = document.getElementById('sticky-nav');
  const hero = document.querySelector('.hero');
  const progress = document.getElementById('scroll-progress');
  const links = document.querySelectorAll('.nav-link');
  const sections = document.querySelectorAll('section[id]');

  window.addEventListener('scroll', () => {
    const heroBottom = hero.offsetTop + hero.offsetHeight;
    nav.classList.toggle('visible', window.scrollY > heroBottom - 60);

    const scrollH = document.documentElement.scrollHeight - window.innerHeight;
    progress.style.width = (scrollH > 0 ? (window.scrollY / scrollH) * 100 : 0) + '%';

    let current = '';
    sections.forEach(sec => {
      if (window.scrollY >= sec.offsetTop - 120) current = sec.id;
    });
    links.forEach(l => l.classList.toggle('active', l.getAttribute('href') === '#' + current));
  }, { passive: true });
})();

// ── Mobile hamburger nav ──────────────────────────────────
(function initHamburger() {
  const hamburger = document.getElementById('nav-hamburger');
  const navLinks = document.getElementById('nav-links');
  if (!hamburger || !navLinks) return;
  hamburger.addEventListener('click', () => {
    const isOpen = hamburger.getAttribute('aria-expanded') === 'true';
    hamburger.setAttribute('aria-expanded', !isOpen);
    navLinks.classList.toggle('open', !isOpen);
  });
  navLinks.querySelectorAll('.nav-link').forEach(link => {
    link.addEventListener('click', () => {
      hamburger.setAttribute('aria-expanded', 'false');
      navLinks.classList.remove('open');
    });
  });
  document.addEventListener('click', (e) => {
    if (!hamburger.contains(e.target) && !navLinks.contains(e.target)) {
      hamburger.setAttribute('aria-expanded', 'false');
      navLinks.classList.remove('open');
    }
  });
})();

// ══════════════════════════════════════════════════════════
// SCROLL FADE-IN ANIMATIONS
// ══════════════════════════════════════════════════════════
(function initScrollAnimations() {
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('in-view'); });
  }, { threshold: 0.08, rootMargin: '0px 0px -40px 0px' });

  document.querySelectorAll('section .container').forEach(el => observer.observe(el));
})();

// ══════════════════════════════════════════════════════════
// URL STATE — share specific examples via URL hash
// ══════════════════════════════════════════════════════════
function encodeState() {
  if (!walkthroughState) return;
  const ws = walkthroughState;
  const hash = '#n=' + ws.N + '&a=' + ws.a;
  if (window.location.hash !== hash) {
    history.replaceState(null, '', hash);
  }
}

function addShareButton() {
  const area = elResultArea;
  const box = area.querySelector('.result-box');
  if (!box) return;
  const btn = document.createElement('button');
  btn.className = 'sm';
  btn.style.marginTop = '10px';
  btn.textContent = 'Copy link to this example';
  btn.addEventListener('click', () => {
    const url = window.location.origin + window.location.pathname + window.location.hash;
    navigator.clipboard.writeText(url).then(() => {
      btn.textContent = 'Copied!';
      setTimeout(() => { btn.textContent = 'Copy link to this example'; }, 2000);
    });
  });
  box.appendChild(btn);
}

// ── Keyboard navigation + shortcut help ─────────────────
function toggleKbdHelp() {
  const overlay = document.getElementById('kbd-help');
  if (overlay.classList.contains('open')) { closeKbdHelp(); return; }
  overlay.classList.add('open');
  overlay.setAttribute('aria-hidden', 'false');
  document.getElementById('kbd-help-close').focus();
}
function closeKbdHelp() {
  const overlay = document.getElementById('kbd-help');
  overlay.classList.remove('open');
  overlay.setAttribute('aria-hidden', 'true');
}
document.getElementById('kbd-help-close').addEventListener('click', closeKbdHelp);
document.getElementById('kbd-help').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) closeKbdHelp();
});

(function initKeyboardNav() {
  document.addEventListener('keydown', (e) => {
    const tag = document.activeElement?.tagName;
    if (tag === 'INPUT' || tag === 'SELECT' || tag === 'TEXTAREA') return;

    if (e.key === '?') { e.preventDefault(); toggleKbdHelp(); return; }
    if (e.key === 'Escape') {
      const overlay = document.getElementById('kbd-help');
      if (overlay.classList.contains('open')) { e.preventDefault(); closeKbdHelp(); return; }
    }

    if (!walkthroughState) return;
    const explorer = document.getElementById('sec-explorer');
    const rect = explorer.getBoundingClientRect();
    if (rect.top > window.innerHeight || rect.bottom < 0) return;

    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
      e.preventDefault();
      if (walkthroughState.currentIndex < walkthroughState.steps.length - 1) advanceStep();
    } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
      e.preventDefault();
      retreatStep();
    }
  });
})();

// ── Touch swipe for step navigation ──────────────────────
(function initSwipeNav() {
  const el = document.getElementById('sec-explorer');
  let startX = 0, startY = 0;
  el.addEventListener('touchstart', (e) => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  }, { passive: true });
  el.addEventListener('touchend', (e) => {
    const dx = e.changedTouches[0].clientX - startX;
    const dy = e.changedTouches[0].clientY - startY;
    if (Math.abs(dx) < 50 || Math.abs(dy) > Math.abs(dx)) return;
    if (!walkthroughState) return;
    if (dx < 0 && walkthroughState.currentIndex < walkthroughState.steps.length - 1) advanceStep();
    else if (dx > 0) retreatStep();
  }, { passive: true });
})();

// Patch startReduction to encode state and add share button
const _origStartReduction = startReduction;
startReduction = function() {
  _origStartReduction();
  setTimeout(encodeState, 100);
};
btnRun.removeEventListener('click', _origStartReduction);
btnRun.addEventListener('click', function() { startReduction(); });

// Patch result renderers to add share button
const _origAdvanceStep = advanceStep;
advanceStep = function() {
  _origAdvanceStep();
  if (walkthroughState) {
    const ws = walkthroughState;
    const step = ws.steps[ws.currentIndex];
    if (step && step.triggers.includes('result')) {
      encodeState();
      setTimeout(addShareButton, 50);
    }
  }
};

const _origShowAllSteps = showAllSteps;
showAllSteps = function() {
  _origShowAllSteps();
  encodeState();
  setTimeout(addShareButton, 50);
};

// Patch auto-play to call patched showAllSteps when it finishes
const _origStartAutoPlay = startAutoPlay;
startAutoPlay = async function() {
  if (autoPlaying) { stopAutoPlay(); return; }
  if (!walkthroughState) return;
  autoPlaying = true;
  btnSkipAll.textContent = '\u23F8 Pause';
  speedControl.style.display = '';
  btnNextStep.disabled = true;
  btnPrevStep.disabled = true;

  while (autoPlaying && walkthroughState && walkthroughState.currentIndex < walkthroughState.steps.length - 1) {
    advanceStep();
    await sleep(playSpeed);
  }

  if (autoPlaying) stopAutoPlay();
};

// Rebind event listeners so they use the patched versions
btnNextStep.removeEventListener('click', _origAdvanceStep);
btnNextStep.addEventListener('click', function() { advanceStep(); });
btnSkipAll.removeEventListener('click', _origStartAutoPlay);
btnSkipAll.addEventListener('click', function() { startAutoPlay(); });

// On page load, check for URL state
(function decodeAndRun() {
  const hash = window.location.hash;
  if (!hash || hash.length < 4) return;

  const params = new URLSearchParams(hash.substring(1));
  const n = parseInt(params.get('n'));
  const a = parseInt(params.get('a'));

  if (isNaN(n) || isNaN(a) || n < 3 || a < 2) return;

  // Set N via preset or custom
  const nOption = selN.querySelector('option[value="' + n + '"]');
  if (nOption) {
    selN.value = n;
    currentN = n;
  } else {
    if (n > 10000 || n % 2 === 0 || isPrime(n) || isPrimePower(n)) return;
    btnCustomN.click();
    inputCustomN.value = n;
    applyCustomN();
  }
  populateBases();

  const aOption = selA.querySelector('option[value="' + a + '"]');
  if (!aOption) return;
  selA.value = a;

  setTimeout(() => {
    document.getElementById('sec-explorer').scrollIntoView({ behavior: 'smooth' });
    startReduction();
    setTimeout(showAllSteps, 300);
  }, 200);
})();

// ══════════════════════════════════════════════════════════
// PARTICLE BACKGROUND (ported from Simon's Algorithm)
// ══════════════════════════════════════════════════════════
(function initParticles() {
  if (prefersReducedMotion) return;
  const canvas = document.getElementById('particleBg');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  let particles = [];
  let paused = false;
  const PARTICLE_COUNT = 45;
  const CONNECT_DIST = 120;
  const colors = [
    'rgba(99, 102, 241, 0.4)',
    'rgba(34, 211, 238, 0.35)',
    'rgba(244, 114, 182, 0.3)',
  ];

  function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }

  function createParticles() {
    particles = [];
    for (let i = 0; i < PARTICLE_COUNT; i++) {
      particles.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random() - 0.5) * 0.4,
        vy: (Math.random() - 0.5) * 0.4,
        r: Math.random() * 2 + 1,
        color: colors[Math.floor(Math.random() * colors.length)],
      });
    }
  }

  function draw() {
    if (paused) return;
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    for (let i = 0; i < particles.length; i++) {
      for (let j = i + 1; j < particles.length; j++) {
        const dx = particles[i].x - particles[j].x;
        const dy = particles[i].y - particles[j].y;
        const dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < CONNECT_DIST) {
          const alpha = (1 - dist / CONNECT_DIST) * 0.15;
          ctx.strokeStyle = `rgba(99, 102, 241, ${alpha})`;
          ctx.lineWidth = 0.5;
          ctx.beginPath();
          ctx.moveTo(particles[i].x, particles[i].y);
          ctx.lineTo(particles[j].x, particles[j].y);
          ctx.stroke();
        }
      }
    }

    for (const p of particles) {
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
      ctx.fillStyle = p.color;
      ctx.fill();

      p.x += p.vx;
      p.y += p.vy;
      if (p.x < 0 || p.x > canvas.width) p.vx *= -1;
      if (p.y < 0 || p.y > canvas.height) p.vy *= -1;
    }

    requestAnimationFrame(draw);
  }

  window.addEventListener('resize', () => { resize(); createParticles(); });
  document.addEventListener('visibilitychange', () => {
    paused = document.hidden;
    if (!paused) draw();
  });

  resize();
  createParticles();
  draw();
})();
</script>

<footer style="text-align:center;padding:2rem 1.5rem;border-top:1px solid var(--border,#2a3550);color:var(--text-dim,#8892a8);font-family:'Inter',sans-serif;font-size:0.82rem;margin-top:3rem;">
  <p style="margin:0 0 0.3rem;">This is a <span style="color:var(--orange,#fb923c);font-weight:500;">beta version</span></p>
  <p style="margin:0;">By <a href="https://granha.github.io" target="_blank" rel="noopener" style="color:var(--accent,#6366f1);text-decoration:none;">Fernando Granha Jeronimo</a></p>
</footer>
</body>
</html>
